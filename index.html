<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fungidentification</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5e6d3; color: #3d2914; min-height: 100vh;
      display: flex; align-items: center; justify-content: center; padding: 20px;
      position: relative; overflow-x: hidden;
    }
    body::before {
      content: ""; position: fixed; inset: 0; pointer-events: none; z-index: 1;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 800'%3E%3Cpath d='M150 100c30-20 60-30 90-20s50 40 40 70c-10 30-40 50-70 40s-60-30-60-60' fill='%23000' opacity='0.03'/%3E%3Cpath d='M900 200c20-15 45-20 65-10s35 35 25 55c-10 20-35 30-55 20s-35-35-35-45' fill='%23000' opacity='0.02'/%3E%3Cpath d='M500 50c0-20 20-40 45-40s45 20 45 40c0 25-20 45-45 45s-45-20-45-45' fill='%23000' opacity='0.02'/%3E%3Cpath d='M100 500c40 0 80 20 80 60s-40 60-80 60s-80-20-80-60 40-60 80-60' fill='%23000' opacity='0.03'/%3E%3Cpath d='M1000 400l20 40-40 20-20-40z' fill='%23000' opacity='0.02'/%3E%3Cpath d='M300 700c15-25 45-35 70-25s35 40 20 65c-15 25-45 35-70 25s-35-40-20-65' fill='%23000' opacity='0.03'/%3E%3C/svg%3E") no-repeat,
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 800'%3E%3Cpath d='M200 300q20-40 60-40t60 40q-20 40-60 40t-60-40' fill='%23000' opacity='0.02'/%3E%3Cpath d='M700 150l30-50 50 30-30 50z' fill='%23000' opacity='0.02'/%3E%3C/svg%3E") no-repeat;
      background-position: 0 0, 50% 50%; background-size: cover, cover;
    }

    .game-container {
      position: relative; z-index: 2; width: 100%; max-width: 1200px;
      background: rgba(255, 248, 240, 0.9); border-radius: 20px; padding: 30px;
      border: 1px solid rgba(139, 90, 43, 0.1); box-shadow: 0 10px 30px rgba(139, 90, 43, 0.15);
    }

    .header { text-align: center; margin-bottom: 30px; }
    h1 { font-size: 2.5rem; font-weight: 800; letter-spacing: -0.5px; color: #5d4e37; }
    .header p { color: #8b7355; margin-top: 6px; }

    .game-info { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
    .info-box { min-width: 160px; text-align: center; padding: 14px 22px; border-radius: 12px; background: rgba(139, 90, 43, 0.08); border: 1px solid rgba(139, 90, 43, 0.15); }
    .info-label { color: #8b7355; font-size: .9rem; margin-bottom: 4px; }
    .info-value { color: #5d4e37; font-size: 1.8rem; font-weight: 700; }

    .start-screen, .loading-screen, .game-screen, .results-screen { display: none; }
    .start-screen.active, .loading-screen.active, .game-screen.active, .results-screen.active { display: block; }

    .start-button, .retry-button, .play-again-button {
      background: linear-gradient(135deg, #8b6f47 0%, #6b5637 100%);
      color: #fff8f0; border: none; padding: 16px 32px; font-size: 1.1rem;
      border-radius: 999px; cursor: pointer; font-weight: 700; display: inline-block;
      transition: transform .2s ease, box-shadow .2s ease; box-shadow: 0 8px 24px rgba(139, 90, 43, .25);
    }
    .start-button:hover, .retry-button:hover, .play-again-button:hover { transform: translateY(-2px); box-shadow: 0 12px 28px rgba(139, 90, 43, .35); }

    .difficulty-select { text-align: center; margin: 24px 0; }
    .difficulty-button { background: #d4c8b8; color: #5d4e37; border: 1px solid #bcaea0; padding: 8px 16px; border-radius: 10px; cursor: pointer; margin: 0 6px; }
    .difficulty-button.active { background: #8b6f47; color: #fff8f0; border-color: transparent; }

    .image-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-bottom: 14px; }
    .image-container { width: 100%; aspect-ratio: 1 / 1; background: #eee0cf; border-radius: 14px; overflow: hidden; border: 2px solid rgba(139, 90, 43, 0.25); }
    .mushroom-image { width: 100%; height: 100%; object-fit: cover; display: block; }

    .game-actions { text-align: center; margin-bottom: 12px; }
    .secondary-action-button { background: #d4c8b8; color: #3d2914; border: 1px solid #bcaea0; padding: 10px 18px; border-radius: 999px; cursor: pointer; font-weight: 600; }
    .secondary-action-button:disabled { opacity: .55; cursor: not-allowed; }

    .options { display: grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 12px; }
    .option-button { background: rgba(255, 248, 240, 0.85); border: 2px solid rgba(139, 90, 43, 0.25); color: #5d4e37; padding: 16px; border-radius: 12px; cursor: pointer; font-weight: 600; text-align: center; }
    .option-button:hover:not(:disabled) { background: rgba(139, 90, 43, 0.15); border-color: rgba(139, 90, 43, 0.45); transform: translateY(-1px); }
    .option-button:disabled { opacity: .75; cursor: not-allowed; }
    .option-button.correct { background: rgba(76, 175, 80, 0.18); border-color: #4CAF50; color: #2e7d32; }
    .option-button.incorrect { background: rgba(244, 67, 54, 0.18); border-color: #F44336; color: #c62828; }

    .loading-spinner { width: 50px; height: 50px; border-radius: 50%; border: 3px solid rgba(139, 90, 43, 0.2); border-top-color: #8b6f47; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .attribution { font-size: .85rem; color: #8b7355; text-align: center; margin-top: 10px; }
    .attribution a { color: #6b5637; text-decoration: none; font-weight: 600; }
    .attribution a:hover { text-decoration: underline; }

    .modal { display: none; position: fixed; inset: 0; background: rgba(61, 41, 20, 0.88); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: #fff8f0; padding: 26px; border-radius: 16px; max-width: 520px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,.3); }
    .error { color: #c9302c; margin: 12px 0 4px; }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="header">
      <h1>üçÑ Fungidentification</h1>
      <p>Test your mycology knowledge in nature's classroom</p>
    </div>

    <div class="game-info">
      <div class="info-box"><div class="info-label">Score</div><div class="info-value" id="score">0</div></div>
      <div class="info-box"><div class="info-label">Question</div><div class="info-value" id="questionCounter">0 / 30</div></div>
    </div>

    <div class="start-screen active">
      <h2 style="text-align:center;margin-bottom:10px;">Welcome to the Mushroom ID Challenge!</h2>
      <p style="text-align:center;margin-bottom:20px;">You will be shown 30 mushroom species to identify. Each round shows 4 photos of the same species.</p>
      <div class="difficulty-select" id="difficultySelect">
        <button class="difficulty-button active" data-difficulty="beginner">Beginner</button>
        <button class="difficulty-button" data-difficulty="intermediate">Intermediate</button>
        <button class="difficulty-button" data-difficulty="expert">Expert</button>
      </div>
      <div style="text-align:center;">
        <button class="start-button" id="startGameBtn">Start Game</button>
      </div>
    </div>

    <div class="loading-screen">
      <h2 style="text-align:center;margin-bottom:10px;">Loading mushroom data‚Ä¶</h2>
      <div class="loading-spinner"></div>
      <p style="text-align:center;margin-top:10px;">Foraging for fungi on iNaturalist.</p>
    </div>

    <div class="game-screen">
      <div class="image-grid" id="imageGrid"></div>
      <div class="game-actions">
        <button id="newPhotosBtn" class="secondary-action-button" style="display:none;">New Photos (1 use)</button>
      </div>
      <div class="options" id="optionsContainer"></div>
    </div>

    <div class="results-screen">
      <h2 style="text-align:center;margin-bottom:10px;">Quiz Complete!</h2>
      <div style="text-align:center;">
        <p style="font-size:1.25rem;">Final Score: <span id="finalScore">0</span> / 300</p>
        <p>Correct Answers: <span id="correctAnswersDisplay">0</span> / <span id="totalQuestionsDisplay">30</span></p>
        <p>Best Streak: <span id="bestStreak">0</span></p>
        <button class="play-again-button" id="playAgainBtn">Play Again</button>
      </div>
    </div>

    <div class="attribution">Images sourced from iNaturalist API under Creative Commons licenses</div>
  </div>

  <div class="modal" id="errorModal">
    <div class="modal-content">
      <h3>Oops! Something went wrong</h3>
      <p class="error" id="errorMessage"></p>
      <button class="retry-button" id="errorModalRetryBtn">Try Again</button>
    </div>
  </div>

  <script>
    // DOM elements
    const scoreDisplay = document.getElementById('score');
    const questionCounterDisplay = document.getElementById('questionCounter');
    const imageGrid = document.getElementById('imageGrid');
    const optionsContainer = document.getElementById('optionsContainer');
    const newPhotosBtn = document.getElementById('newPhotosBtn');

    const finalScoreDisplay = document.getElementById('finalScore');
    const correctAnswersResultsDisplay = document.getElementById('correctAnswersDisplay');
    const totalQuestionsResultsDisplay = document.getElementById('totalQuestionsDisplay');
    const bestStreakDisplay = document.getElementById('bestStreak');

    const errorModal = document.getElementById('errorModal');
    const errorMessageDisplay = document.getElementById('errorMessage');
    const errorModalRetryBtn = document.getElementById('errorModalRetryBtn');

    const startScreen = document.querySelector('.start-screen');
    const loadingScreen = document.querySelector('.loading-screen');
    const gameScreen = document.querySelector('.game-screen');
    const resultsScreen = document.querySelector('.results-screen');

    const startGameBtn = document.getElementById('startGameBtn');
    const playAgainBtn = document.getElementById('playAgainBtn');
    const difficultyButtons = document.querySelectorAll('.difficulty-button');

    // -------------------- Game state --------------------
    let gameState = {
      score: 0, questionsTarget: 30, questionsAnswered: 0,
      currentStreak: 0, bestStreak: 0, correctAnswersCount: 0,
      currentQuestion: null,
      preloadQueue: [], preloadQueueSize: 3,
      activeScreen: 'start', isGameActive: false,
      seenSpeciesIdsThisGame: new Set(), newPhotosUsedThisQuestion: false,
      difficulty: 'beginner'
    };

    // -------------------- Species list --------------------
    const mushroomSpecies = [
      { id: 48715, name: "Fly Agaric", scientific: "Amanita muscaria", genus: "Amanita", category: "Amanita" },
      { id: 53778, name: "Death Cap", scientific: "Amanita phalloides", genus: "Amanita", category: "Amanita" },
      { id: 67661, name: "The Blusher", scientific: "Amanita rubescens", genus: "Amanita", category: "Amanita" },
      { id: 49917, name: "Panther Cap", scientific: "Amanita pantherina", genus: "Amanita", category: "Amanita" },
      { id: 63271, name: "False Death Cap", scientific: "Amanita citrina", genus: "Amanita", category: "Amanita" },
      { id: 58685, name: "Destroying Angel", scientific: "Amanita virosa", genus: "Amanita", category: "Amanita" },
      { id: 350033, name: "Orange Grisette", scientific: "Amanita crocea", genus: "Amanita", category: "Amanita" },
      { id: 143563, name: "Field Mushroom", scientific: "Agaricus campestris", genus: "Agaricus", category: "Agaricus" },
      { id: 118394, name: "Yellow Stainer", scientific: "Agaricus xanthodermus", genus: "Agaricus", category: "Agaricus" },
      { id: 58699, name: "Horse Mushroom", scientific: "Agaricus arvensis", genus: "Agaricus", category: "Agaricus" },
      { id: 58696, name: "Pavement Mushroom", scientific: "Agaricus bitorquis", genus: "Agaricus", category: "Agaricus" },
      { id: 60506, name: "Scaly Wood Mushroom", scientific: "Agaricus silvaticus", genus: "Agaricus", category: "Agaricus" },
      { id: 58646, name: "The Prince", scientific: "Agaricus augustus", genus: "Agaricus", category: "Agaricus" },
      { id: 48530, name: "Oyster Mushroom", scientific: "Pleurotus ostreatus", genus: "Pleurotus", category: "Pleurotus" },
      { id: 120469, name: "Pale Oyster", scientific: "Pleurotus pulmonarius", genus: "Pleurotus", category: "Pleurotus" },
      { id: 125425, name: "Veiled Oyster", scientific: "Pleurotus dryinus", genus: "Pleurotus", category: "Pleurotus" },
      { id: 125683, name: "Golden Oyster", scientific: "Pleurotus citrinopileatus", genus: "Pleurotus", category: "Pleurotus" },
      { id: 54635, name: "Olive Oysterling", scientific: "Sarcomyxa serotina", genus: "Sarcomyxa", category: "Pleurotus" },
      { id: 55245, name: "Scarlet Waxcap", scientific: "Hygrocybe coccinea", genus: "Hygrocybe", category: "Waxcaps" },
      { id: 51869, name: "Crimson Waxcap", scientific: "Hygrocybe punicea", genus: "Hygrocybe", category: "Waxcaps" },
      { id: 128868, name: "Blackening Waxcap", scientific: "Hygrocybe conica", genus: "Hygrocybe", category: "Waxcaps" },
      { id: 63475, name: "Parrot Waxcap", scientific: "Gliophorus psittacinus", genus: "Gliophorus", category: "Waxcaps" },
      { id: 55240, name: "Meadow Waxcap", scientific: "Cuphophyllus pratensis", genus: "Cuphophyllus", category: "Waxcaps" },
      { id: 524919, name: "Heath Waxcap", scientific: "Gliophorus laetus", genus: "Gliophorus", category: "Waxcaps" },
      { id: 48701, name: "King Bolete", scientific: "Boletus edulis", genus: "Boletus", category: "Boletes" },
      { id: 53903, name: "Bay Bolete", scientific: "Imleria badia", genus: "Imleria", category: "Boletes" },
      { id: 53478, name: "Slippery Jack", scientific: "Suillus luteus", genus: "Suillus", category: "Boletes" },
      { id: 63232, name: "Birch Bolete", scientific: "Leccinum scabrum", genus: "Leccinum", category: "Boletes" },
      { id: 54163, name: "Red Cracking Bolete", scientific: "Xerocomellus chrysenteron", genus: "Xerocomellus", category: "Boletes" },
      { id: 125740, name: "Suede Bolete", scientific: "Xerocomus subtomentosus", genus: "Xerocomus", category: "Boletes" },
      { id: 63460, name: "Bleeding Bonnet", scientific: "Mycena haematopus", genus: "Mycena", category: "Mycena" },
      { id: 63446, name: "Common Bonnet", scientific: "Mycena galericulata", genus: "Mycena", category: "Mycena" },
      { id: 63471, name: "Clustered Bonnet", scientific: "Mycena inclinata", genus: "Mycena", category: "Mycena" },
      { id: 63478, name: "Lilac Bonnet", scientific: "Mycena pura", genus: "Mycena", category: "Mycena" },
      { id: 566411, name: "Saffrondrop Bonnet", scientific: "Mycena crocata", genus: "Mycena", category: "Mycena" },
      { id: 194437, name: "Charcoal Burner", scientific: "Russula cyanoxantha", genus: "Russula", category: "Russula" },
      { id: 56079, name: "The Sickener", scientific: "Russula emetica", genus: "Russula", category: "Russula" },
      { id: 49446, name: "Beechwood Sickener", scientific: "Russula nobilis", genus: "Russula", category: "Russula" },
      { id: 63188, name: "Ochre Brittlegill", scientific: "Russula ochroleuca", genus: "Russula", category: "Russula" },
      { id: 210270, name: "Purple Brittlegill", scientific: "Russula atropurpurea", genus: "Russula", category: "Russula" },
      { id: 56081, name: "Greencracked Brittlegill", scientific: "Russula virescens", genus: "Russula", category: "Russula" },
      { id: 125576, name: "Powdery Brittlegill", scientific: "Russula parazurea", genus: "Russula", category: "Russula" },
      { id: 416072, name: "Stinking Brittlegill", scientific: "Russula foetens", genus: "Russula", category: "Russula" },
      { id: 47392, name: "Turkey Tail", scientific: "Trametes versicolor", genus: "Trametes", category: "Brackets & Polypores" },
      { id: 125434, name: "Artist's Conk", scientific: "Ganoderma applanatum", genus: "Ganoderma", category: "Brackets & Polypores" },
      { id: 124459, name: "Red-belted Polypore", scientific: "Fomitopsis pinicola", genus: "Fomitopsis", category: "Brackets & Polypores" },
      { id: 83490, name: "Birch Polypore", scientific: "Fomitopsis betulina", genus: "Fomitopsis", category: "Brackets & Polypores" },
      { id: 410641, name: "Lumpy Bracket", scientific: "Trametes gibbosa", genus: "Trametes", category: "Brackets & Polypores" },
      { id: 118038, name: "Smoky Bracket", scientific: "Bjerkandera adusta", genus: "Bjerkandera", category: "Brackets & Polypores" },
      { id: 47923, name: "Hoof Fungus", scientific: "Fomes fomentarius", genus: "Fomes", category: "Brackets & Polypores" },
      { id: 55653, name: "Beefsteak Fungus", scientific: "Fistulina hepatica", genus: "Fistulina", category: "Brackets & Polypores" },
      { id: 55155, name: "Purplepore Bracket", scientific: "Trichaptum abietinum", genus: "Trichaptum", category: "Brackets & Polypores" },
      { id: 118063, name: "Crimped Gill", scientific: "Plicaturopsis crispa", genus: "Plicaturopsis", category: "Brackets & Polypores" },
      { id: 47347, name: "Golden Chanterelle", scientific: "Cantharellus cibarius", genus: "Cantharellus", category: "Chanterelles & Allies" },
      { id: 175283, name: "Horn of Plenty", scientific: "Craterellus cornucopioides", genus: "Craterellus", category: "Chanterelles & Allies" },
      { id: 350511, name: "Winter Chanterelle", scientific: "Craterellus tubaeformis", genus: "Craterellus", category: "Chanterelles & Allies" },
      { id: 127394, name: "False Chanterelle", scientific: "Hygrophoropsis aurantiaca", genus: "Hygrophoropsis", category: "Chanterelles & Allies" },
      { id: 58857, name: "Hedgehog Fungus", scientific: "Hydnum repandum", genus: "Hydnum", category: "Chanterelles & Allies" },
      { id: 124699, name: "Scaly Chanterelle", scientific: "Turbinellus floccosus", genus: "Turbinellus", category: "Chanterelles & Allies" },
      { id: 123623, name: "Clouded Funnel", scientific: "Clitocybe nebularis", genus: "Clitocybe", category: "Funnels & Grassland" },
      { id: 119227, name: "Trooping Funnel", scientific: "Infundibulicybe geotropa", genus: "Infundibulicybe", category: "Funnels & Grassland" },
      { id: 55239, name: "Fairy Ring Champignon", scientific: "Marasmius oreades", genus: "Marasmius", category: "Funnels & Grassland" },
      { id: 120230, name: "St. George's Mushroom", scientific: "Calocybe gambosa", genus: "Calocybe", category: "Funnels & Grassland" },
      { id: 125429, name: "Brown Mottlegill", scientific: "Panaeolina foenisecii", genus: "Panaeolina", category: "Funnels & Grassland" },
      { id: 47652, name: "Common Puffball", scientific: "Lycoperdon perlatum", genus: "Lycoperdon", category: "Funnels & Grassland" },
      { id: 54026, name: "Shaggy Mane", scientific: "Coprinus comatus", genus: "Coprinus", category: "Funnels & Grassland" },
      { id: 48526, name: "Common Inkcap", scientific: "Coprinopsis atramentaria", genus: "Coprinopsis", category: "Funnels & Grassland" },
      { id: 55453, name: "Magpie Inkcap", scientific: "Coprinopsis picacea", genus: "Coprinopsis", category: "Funnels & Grassland" },
      { id: 127636, name: "Shaggy Parasol", scientific: "Chlorophyllum rhacodes", genus: "Chlorophyllum", category: "Funnels & Grassland" },
      { id: 47468, name: "The Parasol", scientific: "Macrolepiota procera", genus: "Macrolepiota", category: "Funnels & Grassland" },
      { id: 54025, name: "Liberty Cap", scientific: "Psilocybe semilanceata", genus: "Psilocybe", category: "Funnels & Grassland" },
      { id: 125630, name: "Common Conecap", scientific: "Conocybe tenera", genus: "Conocybe", category: "Funnels & Grassland" },
      { id: 119945, name: "Orange Peel Fungus", scientific: "Aleuria aurantia", genus: "Aleuria", category: "Cup & other Saprotrophs" },
      { id: 119224, name: "King Alfred's Cakes", scientific: "Daldinia concentrica", genus: "Daldinia", category: "Cup & other Saprotrophs" },
      { id: 84740, name: "Scarlet Elfcup", scientific: "Sarcoscypha austriaca", genus: "Sarcoscypha", category: "Cup & other Saprotrophs" },
      { id: 55655, name: "Yellow Stagshorn", scientific: "Calocera viscosa", genus: "Calocera", category: "Cup & other Saprotrophs" },
      { id: 117556, name: "Jelly Ear", scientific: "Auricularia auricula-judae", genus: "Auricularia", category: "Cup & other Saprotrophs" },
      { id: 54743, name: "Yellow Brain", scientific: "Tremella mesenterica", genus: "Tremella", category: "Cup & other Saprotrophs" },
      { id: 47346, name: "Funeral Bell", scientific: "Galerina marginata", genus: "Galerina", category: "Woodland Fungi" },
      { id: 56086, name: "False Morel", scientific: "Gyromitra esculenta", genus: "Gyromitra", category: "Woodland Fungi" },
      { id: 54844, name: "Honey Mushroom", scientific: "Armillaria mellea", genus: "Armillaria", category: "Woodland Fungi" },
      { id: 60448, name: "Sheathed Woodtuft", scientific: "Kuehneromyces mutabilis", genus: "Kuehneromyces", category: "Woodland Fungi" },
      { id: 417180, name: "Common Rustgill", scientific: "Gymnopilus penetrans", genus: "Gymnopilus", category: "Woodland Fungi" },
      { id: 56021, name: "Velvet Shank", scientific: "Flammulina velutipes", genus: "Flammulina", category: "Woodland Fungi" },
      { id: 481482, name: "Wrinkled Peach", scientific: "Rhodotus palmatus", genus: "Rhodotus", category: "Woodland Fungi" },
      { id: 63433, name: "Golden Scalycap", scientific: "Pholiota aurivella", genus: "Pholiota", category: "Woodland Fungi" },
      { id: 53715, name: "Lion's Mane", scientific: "Hericium erinaceus", genus: "Hericium", category: "Distinctive Oddballs" },
      { id: 55265, name: "Chicken of the Woods", scientific: "Laetiporus sulphureus", genus: "Laetiporus", category: "Distinctive Oddballs" },
      { id: 84613, name: "Hen of the Woods", scientific: "Grifola frondosa", genus: "Grifola", category: "Distinctive Oddballs" },
      { id: 57343, name: "Giant Puffball", scientific: "Calvatia gigantea", genus: "Calvatia", category: "Distinctive Oddballs" },
      { id: 469901, name: "Devil's Fingers", scientific: "Clathrus archeri", genus: "Clathrus", category: "Distinctive Oddballs" },
      { id: 53764, name: "Dead Man's Fingers", scientific: "Xylaria polymorpha", genus: "Xylaria", category: "Distinctive Oddballs" },
      { id: 119152, name: "Wood Blewit", scientific: "Lepista nuda", genus: "Lepista", category: "Blewits & Lookalikes" },
      { id: 1039723, name: "Field Blewit", scientific: "Lepista saeva", genus: "Lepista", category: "Blewits & Lookalikes" },
      { id: 417492, name: "Lilac Fibrecap", scientific: "Inocybe lilacina", genus: "Inocybe", category: "Blewits & Lookalikes" },
      { id: 63509, name: "Amethyst Deceiver", scientific: "Laccaria amethystina", genus: "Laccaria", category: "Blewits & Lookalikes" },
      { id: 55254, name: "Bruising Webcap", scientific: "Cortinarius purpurascens", genus: "Cortinarius", category: "Blewits & Lookalikes" }
    ];

    // -------------------- Helpers --------------------
    const observationCache = new Map();
    const delay = (ms) => new Promise(res => setTimeout(res, ms));
    let fetchQueue = Promise.resolve();
    let lastFetchTimestamp = 0; // simple 1 rps throttle

    function switchScreen(screen) {
      startScreen.classList.remove('active'); loadingScreen.classList.remove('active');
      gameScreen.classList.remove('active'); resultsScreen.classList.remove('active');
      if (screen === 'start') startScreen.classList.add('active');
      else if (screen === 'loading') loadingScreen.classList.add('active');
      else if (screen === 'game') gameScreen.classList.add('active');
      else if (screen === 'results') resultsScreen.classList.add('active');
      gameState.activeScreen = screen;
    }

    function showError(message, retryFn = null, retryLabel = 'Try Again') {
      errorMessageDisplay.textContent = message;
      errorModalRetryBtn.textContent = retryLabel;
      errorModalRetryBtn.onclick = () => { errorModal.classList.remove('active'); if (retryFn) retryFn(); };
      errorModal.classList.add('active');
    }

    function handleImageError(img) { img.style.opacity = 0.3; img.alt = 'Image unavailable'; }

    function randomChoice(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    // -------------------- iNaturalist fetch --------------------
    async function fetchMushroomObservations(taxonId, excludeObservationId = null) {
      const execute = async () => {
        // throttle ~1 rps
        const now = Date.now();
        const wait = Math.max(0, 1000 - (now - lastFetchTimestamp));
        if (wait) await delay(wait);
        lastFetchTimestamp = Date.now();

        const cacheKey = `${taxonId}|${excludeObservationId || ''}`;
        const cached = observationCache.get(cacheKey);
        if (cached && cached.timestamp > Date.now() - 24 * 60 * 60 * 1000) return cached.data;

        const requestedSpeciesInfo = mushroomSpecies.find(s => s.id === taxonId);

        const base = 'https://api.inaturalist.org/v1/observations';
        const params = new URLSearchParams({
          taxon_id: String(taxonId),
          iconic_taxa: 'Fungi',          // server-side filter
          photos: 'true',
          per_page: '200',
          order: 'desc',
          order_by: 'observed_on',      // stable ordering
          locale: 'en'
        });
        if (excludeObservationId) params.set('not_id', String(excludeObservationId));

        const runQuery = async (url) => {
          const res = await fetch(url);
          if (!res.ok) {
            let details = '';
            try { details = JSON.stringify(await res.json()); } catch {}
            throw new Error(`API ${res.status} for taxon ${taxonId} ${details}`);
          }
          return res.json();
        };

        const apiUrl = `${base}?${params.toString()}`;
        let data;
        try {
          data = await runQuery(apiUrl);
        } catch (e) {
          console.error(e.message);
          data = { results: [] };
        }

        const ALLOWED = new Set(['cc0','cc-by','cc-by-sa','cc-by-nd','cc-by-nc','cc-by-nc-sa','cc-by-nc-nd']);
        let observationsWithPhotos = (data.results || []).filter(obs => {
          if (!obs || !obs.photos || !obs.photos.length || !obs.taxon) return false;
          // ensure at least one CC-licensed photo
          return obs.photos.some(p => ALLOWED.has(String(p.license_code || '').toLowerCase()));
        });

        // Fallback: try a different ordering if we saw nothing
        if (!observationsWithPhotos.length) {
          const usp = new URLSearchParams(params);
          usp.set('order_by', 'created_at');
          const fallbackUrl = `${base}?${usp.toString()}`;
          try {
            const d2 = await runQuery(fallbackUrl);
            observationsWithPhotos = (d2.results || []).filter(obs => obs && obs.photos && obs.photos.length && obs.taxon && obs.photos.some(p => ALLOWED.has(String(p.license_code || '').toLowerCase())));
          } catch (e) { console.warn('Fallback query failed:', e.message); }
        }

        if (!observationsWithPhotos.length) {
          console.warn(`No observations with photos for taxon ${taxonId} (${requestedSpeciesInfo?.name}).`);
          return { photos: [], attribution: 'Not enough quality photos found.', observationUrl: null, error: true, speciesId: taxonId, observationId: null };
        }

        // Shuffle, then pick an observation that matches the requested species (or its infraspecific children)
        observationsWithPhotos.sort(() => 0.5 - Math.random());
        let selected = null;
        for (const obs of observationsWithPhotos) {
          const t = obs.taxon;
          if (t?.iconic_taxon_name && t.iconic_taxon_name !== 'Fungi') continue; // guard
          if (t && (t.id === taxonId || (Array.isArray(t.ancestor_ids) && t.ancestor_ids.includes(taxonId)))) { selected = obs; break; }
        }
        if (!selected) selected = observationsWithPhotos[0];

        // Choose up to 3 CC-licensed photos and expand to 4 tiles
        const goodPhotos = selected.photos.filter(p => ALLOWED.has(String(p.license_code || '').toLowerCase()));
        const pick = goodPhotos.slice(0, 3);
        const photos = pick.map(p => {
          const url = p.medium_url || (p.url ? p.url.replace('square','medium') : p.url) || p.small_url || p.url;
          return { url, attribution: p.attribution || 'iNaturalist contributor' };
        });
        while (photos.length < 4 && photos.length) photos.push({ ...photos[0] });
        if (!photos.length) return { photos: [], attribution: 'No suitable licensed photos.', observationUrl: null, error: true, speciesId: taxonId, observationId: null };

        const result = {
          photos,
          attribution: `Photos by ${selected.user?.login || 'Unknown User'} via iNaturalist`,
          observationUrl: selected.uri,
          observationId: selected.id,
          error: false,
          speciesId: taxonId
        };

        observationCache.set(cacheKey, { data: result, timestamp: Date.now() });
        return result;
      };

      const queued = fetchQueue.then(execute);
      fetchQueue = queued.catch(() => {});
      return queued;
    }

    // -------------------- Game flow --------------------
    function updateQuestionCounter() { questionCounterDisplay.textContent = `${gameState.questionsAnswered + 1} / ${gameState.questionsTarget}`; }
    function updateDisplay() { scoreDisplay.textContent = gameState.score; }

    function selectSpeciesForPreload(currentCorrectSpeciesId = null) {
      const preloadedIds = gameState.preloadQueue.map(it => it.speciesId);
      let candidates = mushroomSpecies.filter(s => s.id !== currentCorrectSpeciesId && !gameState.seenSpeciesIdsThisGame.has(s.id) && !preloadedIds.includes(s.id));
      if (!candidates.length) candidates = mushroomSpecies.filter(s => s.id !== currentCorrectSpeciesId && !preloadedIds.includes(s.id));
      if (!candidates.length) return null;
      return randomChoice(candidates);
    }

    async function maintainPreloadQueue(currentCorrectSpeciesId = null) {
      if (!gameState.isGameActive) return;
      while (gameState.preloadQueue.length < gameState.preloadQueueSize) {
        const species = selectSpeciesForPreload(currentCorrectSpeciesId);
        if (!species) break;
        try {
          const data = await fetchMushroomObservations(species.id);
          if (data && !data.error && data.photos?.length) {
            gameState.preloadQueue.push({ speciesId: species.id, data, species, timestamp: Date.now() });
          }
        } catch (e) { console.warn('Preload failed for', species?.name, e); }
      }
    }

    function popPreloaded(speciesId) {
      const i = gameState.preloadQueue.findIndex(it => it.speciesId === speciesId);
      if (i !== -1) return gameState.preloadQueue.splice(i, 1)[0].data;
      return null;
    }

    async function startGame() {
      gameState.score = 0; gameState.questionsAnswered = 0; gameState.currentStreak = 0; gameState.bestStreak = 0; gameState.correctAnswersCount = 0;
      gameState.currentQuestion = null; gameState.preloadQueue = []; gameState.seenSpeciesIdsThisGame.clear(); gameState.newPhotosUsedThisQuestion = false;
      updateDisplay(); questionCounterDisplay.textContent = `0 / ${gameState.questionsTarget}`; switchScreen('loading'); gameState.isGameActive = true;

      // Try several times to secure a first question before giving up
      let success = false; let errLast = null;
      for (let attempt = 0; attempt < 6 && !success; attempt++) {
        try { await loadNewQuestion(true); success = true; }
        catch (err) { errLast = err; console.warn('Initial load attempt failed', attempt+1, err.message); }
      }
      if (!success) {
        console.error('Failed to start:', errLast);
        showError('Could not load the first mushroom question. Please try again.', () => { startGame(); }, 'Restart');
        gameState.isGameActive = false; return;
      }

      try { await maintainPreloadQueue(); } catch (e) { console.warn('Preload after start failed:', e.message); }
      if (!gameState.isGameActive) return; switchScreen('game');
    }

    async function loadNewQuestion(isInitialLoad = false) {
      if (!gameState.isGameActive) return;
      updateQuestionCounter();

      // choose a correct species we haven't used this game (if possible)
      let candidates = mushroomSpecies.filter(s => !gameState.seenSpeciesIdsThisGame.has(s.id));
      if (!candidates.length) candidates = [...mushroomSpecies];
      const correct = randomChoice(candidates);

      // Load observation data (prefer preloaded)
      let data = popPreloaded(correct.id) || await fetchMushroomObservations(correct.id);
      if (!data || data.error || !data.photos?.length) {
        if (isInitialLoad) throw new Error('Failed to load initial question');
        showError('Could not find a suitable mushroom for the next question.', () => loadNewQuestion(false), 'Try Next');
        return;
      }

      gameState.seenSpeciesIdsThisGame.add(correct.id);
      gameState.newPhotosUsedThisQuestion = false;
      newPhotosBtn.style.display = 'block'; newPhotosBtn.disabled = false; newPhotosBtn.textContent = 'New Photos (1 use)';

      // Build options based on difficulty
      const options = [correct];
      const correctCategory = correct.category;
      const shuffled = (arr) => arr.slice().sort(() => 0.5 - Math.random());

      if (gameState.difficulty === 'expert') {
        let same = shuffled(mushroomSpecies.filter(s => s.category === correctCategory && s.id !== correct.id));
        while (options.length < 4 && same.length) options.push(same.shift());
      } else if (gameState.difficulty === 'intermediate') {
        let same = shuffled(mushroomSpecies.filter(s => s.category === correctCategory && s.id !== correct.id));
        if (same.length) options.push(same.shift());
        let usedCats = new Set(options.map(o => o.category));
        let others = shuffled(mushroomSpecies.filter(s => s.category !== correctCategory));
        for (const sp of others) { if (options.length >= 4) break; if (!usedCats.has(sp.category)) { options.push(sp); usedCats.add(sp.category); } }
      } else { // beginner
        let usedCats = new Set(options.map(o => o.category));
        let others = shuffled(mushroomSpecies.filter(s => s.category !== correctCategory));
        for (const sp of others) { if (options.length >= 4) break; if (!usedCats.has(sp.category)) { options.push(sp); usedCats.add(sp.category); } }
      }

      if (options.length < 4) {
        let filler = shuffled(mushroomSpecies.filter(s => !options.some(o => o.id === s.id)));
        while (options.length < 4 && filler.length) options.push(filler.shift());
      }

      options.sort(() => 0.5 - Math.random());

      gameState.currentQuestion = { correct, options, currentObservationId: data.observationId, observationUrl_DEBUG: data.observationUrl };

      // Render images (2x2)
      imageGrid.innerHTML = data.photos.map(p => `
        <div class="image-container"><img src="${p.url}" class="mushroom-image" alt="Mushroom photo" onerror="handleImageError(this)"></div>
      `).join('');
      const oldAttr = imageGrid.querySelector('.attribution'); if (oldAttr) oldAttr.remove();
      const attr = document.createElement('div'); attr.className = 'attribution';
      let attrText = data.attribution; if (data.observationUrl) attrText += ` <a href="${data.observationUrl}" target="_blank" rel="noopener">View on iNaturalist</a>`;
      attr.innerHTML = attrText; imageGrid.appendChild(attr);

      // Render options
      optionsContainer.innerHTML = options.map((sp, idx) => `<button class="option-button" data-index="${idx}">${sp.name}<br><small style="opacity:.75"><em>${sp.scientific}</em></small></button>`).join('');

      // keep preloading others
      maintainPreloadQueue(correct.id);
    }

    async function handleNewPhotosRequest() {
      if (!gameState.isGameActive || !gameState.currentQuestion || gameState.newPhotosUsedThisQuestion) return;
      gameState.newPhotosUsedThisQuestion = true; newPhotosBtn.disabled = true; newPhotosBtn.textContent = 'Loading‚Ä¶';
      const taxonId = gameState.currentQuestion.correct.id; const excludeId = gameState.currentQuestion.currentObservationId;
      const newData = await fetchMushroomObservations(taxonId, excludeId);
      if (newData && !newData.error && newData.photos?.length) {
        imageGrid.innerHTML = newData.photos.map(p => `<div class="image-container"><img src="${p.url}" class="mushroom-image" onerror="handleImageError(this)"></div>`).join('');
        const oldAttr = imageGrid.querySelector('.attribution'); if (oldAttr) oldAttr.remove();
        const attr = document.createElement('div'); attr.className = 'attribution';
        let attrText = newData.attribution; if (newData.observationUrl) attrText += ` <a href="${newData.observationUrl}" target="_blank" rel="noopener">View on iNaturalist</a>`;
        attr.innerHTML = attrText; imageGrid.appendChild(attr);
        gameState.currentQuestion.currentObservationId = newData.observationId;
        gameState.currentQuestion.observationUrl_DEBUG = newData.observationUrl;
        newPhotosBtn.textContent = 'New Photos Used';
      } else {
        showError('Could not find alternative photos for this mushroom.');
        newPhotosBtn.textContent = 'No Alternatives Found';
      }
    }

    function selectAnswer(index) {
      if (!gameState.isGameActive || !gameState.currentQuestion) return;
      const selected = gameState.currentQuestion.options[index];
      const correct = gameState.currentQuestion.correct;
      const buttons = optionsContainer.querySelectorAll('.option-button');
      buttons.forEach(b => b.disabled = true);
      newPhotosBtn.disabled = true;

      if (selected.id === correct.id) {
        gameState.score += 10; gameState.currentStreak++; gameState.correctAnswersCount++;
        if (gameState.currentStreak > gameState.bestStreak) gameState.bestStreak = gameState.currentStreak;
        buttons[index].classList.add('correct');
      } else {
        gameState.currentStreak = 0;
        buttons[index].classList.add('incorrect');
        const correctIndex = [...buttons].findIndex((b, i) => gameState.currentQuestion.options[i].id === correct.id);
        if (correctIndex !== -1) buttons[correctIndex].classList.add('correct');
      }

      gameState.questionsAnswered++;
      updateDisplay();

      if (gameState.questionsAnswered >= gameState.questionsTarget) {
        finalScoreDisplay.textContent = gameState.score;
        correctAnswersResultsDisplay.textContent = gameState.correctAnswersCount;
        totalQuestionsResultsDisplay.textContent = gameState.questionsTarget;
        bestStreakDisplay.textContent = gameState.bestStreak;
        switchScreen('results'); gameState.isGameActive = false;
      } else {
        setTimeout(() => loadNewQuestion(false), 600);
      }
    }

    function resetGame() { switchScreen('start'); }

    async function checkAPIStatus() {
      try {
        const r = await fetch('https://api.inaturalist.org/v1/observations?per_page=1');
        if (!r.ok) showError('iNaturalist API may be having issues. Please try again later.');
      } catch {
        showError('Cannot connect to iNaturalist API. Please check your internet and try again.');
      }
    }

    // -------------------- Event wiring --------------------
    startGameBtn.addEventListener('click', startGame);
    playAgainBtn.addEventListener('click', () => { switchScreen('start'); });
    newPhotosBtn.addEventListener('click', handleNewPhotosRequest);
    difficultyButtons.forEach(btn => btn.addEventListener('click', () => {
      difficultyButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      gameState.difficulty = btn.dataset.difficulty;
    }));

    optionsContainer.addEventListener('click', (e) => {
      const btn = e.target.closest('.option-button');
      if (!btn || btn.disabled) return;
      const idx = parseInt(btn.dataset.index, 10);
      if (!Number.isNaN(idx)) selectAnswer(idx);
    });

    window.addEventListener('load', () => {
      checkAPIStatus();
      questionCounterDisplay.textContent = `0 / ${gameState.questionsTarget}`;
      const active = document.querySelector('.difficulty-button.active');
      if (active) gameState.difficulty = active.dataset.difficulty;
      switchScreen('start');
    });
  </script>
</body>
</html>
