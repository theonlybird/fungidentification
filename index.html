<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F9N3PXVH2R"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-F9N3PXVH2R');
</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fungidentification</title>
 <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%F0%9F%8D%84%3C/text%3E%3C/svg%3E">
  <style>
    html, body { min-height: 100%; }
    :root{
      --bg:#f5e6d3; --card:#fff8f0; --ink:#3d2914; --ink-2:#5d4e37; --muted:#8b7355;
      --brand-1:#8b6f47; --brand-2:#6b5637; --ring:rgba(139,90,43,.15);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:var(--bg); color:var(--ink); padding:20px; display:flex; justify-content:center;
    }
    .game{width:100%; max-width:1000px; background:var(--card); border-radius:20px; padding:24px;
      border:1px solid rgba(139,90,43,.12); box-shadow:0 10px 30px rgba(139,90,43,.15)}
    .header{ text-align:center; margin-bottom:28px }
    h1{margin:0; font-size:2.25rem; color:var(--ink-2); font-weight:700}
    .sub{color:var(--muted)}

    /* HUD (hidden on landing; side-by-side on mobile) */
    .hud{ display:none; justify-content:center; gap:16px; flex-wrap:wrap; margin:14px 0 10px}
    .hud .box{min-width:150px; padding:10px 16px; text-align:center; border-radius:12px;
      background:rgba(139,90,43,.08); border:1px solid var(--ring)}
    .hud .label{color:var(--muted); font-size:.9rem}
    .hud .value{color:var(--ink-2); font-weight:600; font-size:1.45rem}

    /* Screens */
    .screen{display:none}
    .screen.active{display:block}

    .copyright-note{
      margin-top:14px;
      text-align:center;
      font-size:.7rem;
      color:var(--muted);
    }
    @media (max-width:480px){ .copyright-note{ font-size:.85rem } }

    /* Option rows (Length + Difficulty) */
    .difficulty{ display:flex; justify-content:center; gap:10px; flex-wrap:nowrap; margin:14px 0 24px }
    .diff-btn{
      background:#d4c8b8; color:var(--ink-2); border:1px solid #bcaea0; border-radius:999px;
      padding:10px 16px; min-width:110px; font-weight:700; cursor:pointer
    }
    .diff-btn.active{ background:var(--brand-1); color:#fff; border-color:transparent }
    @media (max-width:520px){
      .difficulty{ gap:8px; flex-wrap:wrap }
      .diff-btn{ min-width:120px; padding:8px 12px; font-size:.95rem }
    }

    /* Bigger Start button (landing only) */
    #startBtn{
      font-size: clamp(1.1rem, 2.2vw, 1.35rem);
      padding: clamp(16px, 2.6vw, 20px) clamp(32px, 6.5vw, 48px);
      min-width: clamp(220px, 42vw, 340px);
      border-radius: 999px;
    }

    /* Welcome screen intro text */
    #start .intro{
      max-width: 820px;
      margin: 18px auto 28px;
      padding: 0 12px;
      color: var(--muted);
      font-size: 1rem;
      line-height: 1.6;
      text-align: left;
    }
    #start .intro p{ margin: 0 0 12px; }
    @media (max-width: 560px){
      #start .intro{ font-size: .97rem; line-height: 1.55; }
    }

    /* Large gap before copyright on the landing screen */
    #start .copyright-note{ margin-top: 56px; }

    /* Image grid (2×2 always) */
    .image-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; max-width:740px; margin:0 auto 10px }
    .img-card{ border:2px solid var(--ring); border-radius:14px; overflow:hidden; background:transparent; }
    .img-wrap{ position:relative; aspect-ratio:1/1; background:#eee0cf; }
    .img-wrap img{ width:100%; height:100%; object-fit:cover; display:block }

    /* License caption: translucent overlay ON the photo */
    .credit{
      position:absolute;
      left:6px; right:6px; bottom:6px;
      z-index:2;
      padding:4px 8px;
      font-size: clamp(8px, 1.6vw, 12px);
      line-height:1.25;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      display:flex; gap:8px; align-items:center; justify-content:center;
      color:var(--muted);
      background: linear-gradient(to bottom, rgba(255,255,255,.78), rgba(255,255,255,.62));
      -webkit-backdrop-filter: blur(4px) saturate(120%);
      backdrop-filter: blur(4px) saturate(120%);
      border:1px solid rgba(0,0,0,.12);
      border-radius:10px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
      pointer-events:none;
    }
    .credit .name{white-space:nowrap}
    .license-badge{
      font-size: 0.92em; font-weight:700; letter-spacing:.2px; color:#4b3a23;
      white-space:nowrap;
      border:1px solid rgba(0,0,0,.18);
      border-radius:6px;
      padding:1px 6px;
      background: rgba(231,219,205,.55);
      flex:0 0 auto;
    }

    /* Controls */
    .actions{ text-align:center; margin:10px 0 12px }
    #newPhotosBtn{
      display:inline-flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg, var(--brand-1), var(--brand-2)); color:#fff;
      border:none; padding:12px 24px; border-radius:999px; font-weight:700; cursor:pointer;
      box-shadow:0 8px 24px rgba(139,90,43,.25)
    }
    #newPhotosBtn:disabled{
      background:#bdb5a9 !important;
      box-shadow:none !important;
      cursor:not-allowed;
      opacity:.95;
    }

    /* Answers grid */
    .answers{ display:grid; gap:12px; max-width:740px; margin:0 auto; grid-template-columns:repeat(4, minmax(0,1fr)); }
    @media (max-width:768px){ .answers{ grid-template-columns:repeat(2, minmax(0,1fr)); } }
    .answer{
      background: rgba(255,248,240,.9); border:2px solid var(--ring); border-radius:12px;
      padding:14px; text-align:center; font-weight:600; cursor:pointer;
      color:var(--ink-2);
      transition: background-color .15s ease, border-color .15s ease, transform .06s ease, box-shadow .15s ease;
    }
    @media (hover: hover) and (pointer: fine){
      .answer:hover:not(:disabled):not(.correct):not(.incorrect){
        background: rgba(139,90,43,.16);
        border-color: rgba(139,90,43,.38);
        box-shadow: 0 4px 12px rgba(139,90,43,.18);
        transform: translateY(-1px);
      }
      .answer:active:not(:disabled):not(.correct):not(.incorrect){
        transform: translateY(0);
        background: rgba(139,90,43,.22);
      }
      .answer:focus-visible{
        outline: 3px solid rgba(139,90,43,.45);
        outline-offset: 2px;
      }
    }
    .answer small{
      display:block;
      margin-top:4px;
      color:var(--muted);
      font-weight:400;
      font-style: italic;
      line-height:1.2;
      font-size:.95em;
    }
    .answer.correct{ background:rgba(76,175,80,.18); border-color:#4CAF50; color:#2e7d32}
    .answer.incorrect{ background:rgba(244,67,54,.18); border-color:#F44336; color:#c62828}
    .answer:disabled:not(.correct):not(.incorrect){ opacity:.75; cursor:not-allowed }

    /* Text input layout and styling */
    .text-input-row{ grid-column:1 / -1; max-width:900px; margin:0 auto; display:flex; gap:10px; }
    .text-input{ flex-grow:1; text-align:left; cursor:text; padding:16px; font-size:1.1rem; }

    .footnote{ text-align:center; color:var(--muted); margin-top:10px }

    /* Modal */
    .modal{ position:fixed; inset:0; background:rgba(61,41,20,.85); display:none; place-items:center; z-index:1000 }
    .modal.active{ display:grid }
    .modal .card{ background:var(--card); padding:24px; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,.35); text-align:center }
    .btn{ background:linear-gradient(135deg, var(--brand-1), var(--brand-2)); color:#fff; border:none; padding:12px 22px; border-radius:999px; font-weight:700; cursor:pointer }

    @media (max-width: 420px) {
      .credit{ font-size: clamp(6px, 2.8vw, 9px); padding: 3px 6px; }
      .license-badge{ font-size: 0.9em; padding: 0 5px; letter-spacing: 0; }
    }

    /* Landing spacing tweaks */
    #start h2{ margin: 24px 0 12px !important; }
    #start p{ margin: 0 0 22px !important; }

    /* ---------- Review table ---------- */
    .review-wrap{
      margin: 6px auto 0;
      max-width: 940px;
      background: #fffdf7;
      border: 1px solid rgba(139,90,43,.12);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(139,90,43,.12);
      overflow: hidden;
    }
    .review-table{ width:100%; border-collapse:collapse; font-size:.95rem }
    .review-table thead th{
      text-align:left; background:rgba(139,90,43,.08); color:var(--ink-2);
      font-weight:700; padding:12px 14px; border-bottom:1px solid rgba(139,90,43,.18);
    }
    .review-table tbody td{
      padding:12px 14px; border-bottom:1px solid rgba(139,90,43,.08); vertical-align:top;
    }
    .review-table tbody tr:nth-child(even){ background:rgba(139,90,43,.03) }
    .review-table .fungus-name{ font-weight:700; color:var(--ink-2) }
    .review-table .fungus-sci{ display:block; color:var(--muted); font-style:italic }
    .badge{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:.85em; font-weight:700; letter-spacing:.2px }
    .badge.ok{ background:rgba(76,175,80,.15); color:#1b5e20; border:1px solid rgba(76,175,80,.35) }
    .badge.no{ background:rgba(244,67,54,.15); color:#8a1c13; border:1px solid rgba(244,67,54,.35) }
    .review-table a{ color:var(--brand-2); text-decoration:underline; word-break:break-word }
    @media (max-width:640px){
      .review-table{ font-size:.9rem }
      .review-table thead th, .review-table tbody td{ padding:10px 12px }
    }

    /* THEME: Mossy Woodland (seamless background) */
    body.theme-woodland{
      background:
        radial-gradient(120vmax 80vmax at 50% -10vmax, rgba(255,255,255,.55), transparent 65%),
        radial-gradient(160vmax 120vmax at 50% 130%, rgba(0,0,0,.08), transparent 70%),
        linear-gradient(180deg, #203a2b 0%, #2d513c 45%, #375d46 100%);
      background-attachment: fixed, fixed, fixed;

      --ink:#1f2b23; --ink-2:#2d3f32; --muted:#6f846f;
      --brand-1:#4d8b6b; --brand-2:#386e53; --ring:rgba(77,139,107,.22);
    }
    @media (max-width: 900px){
      body.theme-woodland{ background-attachment: scroll, scroll, scroll; }
    }
    body.theme-woodland .game{
      background:#fbf7f0;
      border:1px solid #214a37;
      box-shadow: 0 18px 50px rgba(10,35,22,.35);
    }
    body.theme-woodland .header::after{
      content:"";
      display:block; height:10px; margin:14px auto 0; width:min(520px,80%);
      background:
        url('data:image/svg+xml;utf8,\
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 10">\
            <path d="M3 6c18-8 36 8 54 0 18-8 36 8 54 0" fill="none" stroke="%236c8f75" stroke-width="2" stroke-linecap="round"/>\
            <circle cx="16" cy="6" r="1.2" fill="%236c8f75"/><circle cx="39" cy="6" r="1.2" fill="%236c8f75"/>\
            <circle cx="62" cy="6" r="1.2" fill="%236c8f75"/><circle cx="85" cy="6" r="1.2" fill="%236c8f75"/>\
          </svg>') center/contain no-repeat;
      opacity:.8;
    }
    body.theme-woodland .diff-btn{ background:#e3efe7; border-color:#b4ccb9; color:#2d3f32 }
    body.theme-woodland .diff-btn.active{ background:var(--brand-1) }
    body.theme-woodland #newPhotosBtn,
    body.theme-woodland .btn{
      background:linear-gradient(135deg, var(--brand-1), var(--brand-2));
      box-shadow:0 10px 28px rgba(56,110,83,.30);
    }
    body.theme-woodland .img-card{ border-color: rgba(77,139,107,.22) }
    body.theme-woodland .review-wrap{ background:#fffef9; border-color:rgba(56,110,83,.20) }
    body.theme-woodland .review-table thead th{ background:rgba(56,110,83,.08); color:#223329 }

/* Allow horizontal scroll for results table on narrow screens */
.table-scroll{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
.table-scroll table{ min-width: 640px; } /* ensure scrolling when viewport is narrower */


/* Scientific Mode toggle */
.switch{ position:relative; display:inline-block; width:52px; height:28px; }
.switch input{ opacity:0; width:0; height:0; }
.slider{ position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#d4c8b8; border:1px solid #bcaea0; border-radius:999px; transition:.2s; }
.slider:before{ position:absolute; content:""; height:22px; width:22px; left:3px; top:50%; transform:translateY(-50%); background:white; border-radius:50%; transition:.2s; box-shadow:0 1px 2px rgba(0,0,0,.2); }
.switch input:checked + .slider{ background:var(--brand-1); border-color:transparent; }
.switch input:checked + .slider:before{ transform:translate(24px, -50%); }
#scientificRow{ justify-content:center; gap:12px; }
#scientificRow .sci-title{ font-weight:700; color:var(--ink-2); margin-right:8px; }
#scientificRow .sci-desc{ color:var(--muted); font-size:.95rem; }
@media (max-width:640px){
  #scientificRow{ flex-wrap:wrap; }
  #scientificRow .sci-copy{ text-align:center; }
}

</style>

  <style>
  /* --- Patch A: responsive text-input row --- */
  .text-input-row{
    align-items: stretch;
  }
  .text-input-row .text-input{
    flex: 1 1 0;
    min-width: 0;
    width: 100%;
  }
  #textAnswerSubmit{ flex: 0 0 auto; }
  @media (max-width: 520px){
    .text-input-row{ flex-wrap: wrap; }
    #textAnswerSubmit{ width: 100%; }
  }
  /* --- End Patch A --- */
  </style>

  <style>
  /* --- Patch A v2: make input row exactly as wide as the 4-photo grid and keep it inside on mobile --- */
  .text-input-row{
    grid-column: 1 / -1;
    max-width: 740px !important;  /* match .answers grid */
    width: 100%;
    margin: 0 auto;
    display: flex;
    gap: 10px;
    align-items: stretch;
  }
  .text-input-row .text-input{
    flex: 1 1 auto;
    min-width: 0;                 /* allow shrinking instead of overflowing */
    width: auto;
  }
  #textAnswerSubmit{ 
    flex: 0 0 auto; 
    white-space: nowrap;
  }
  @media (max-width: 520px){
    .text-input-row{ flex-wrap: wrap; }
    #textAnswerSubmit{ width: 100%; }
  }
  /* --- End Patch A v2 --- */

  /* --- Animated Transitions --- */
  .game-content-wrapper {
    position: relative;
    min-height: 500px; /* Prevent layout collapse during transition */
  }

  @keyframes slide-out-up {
    from {
      transform: translateY(0);
      opacity: 1;
    }
    to {
      transform: translateY(-30px);
      opacity: 0;
    }
  }

  @keyframes slide-in-down {
    from {
      transform: translateY(30px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .is-exiting {
    animation: slide-out-up 0.3s ease-out forwards;
  }

  .is-entering {
    animation: slide-in-down 0.3s ease-in forwards;
    /* Start with content hidden to prevent flash */
    visibility: hidden;
  }
  .is-entering.visible {
    visibility: visible;
  }

  /* --- Results Difficulty Pill --- */
  .difficulty-pill {
    display: inline-block;
    margin: 0 auto 8px;
    padding: 8px 16px;
    border-radius: 999px;
    background: rgba(139,90,43,.1);
    border: 1px solid rgba(139,90,43,.2);
    color: var(--ink-2);
    font-weight: 700;
    text-transform: capitalize;
  }
  .difficulty-pill.scientific {
    background: rgba(77,139,107,.15);
    border-color: rgba(77,139,107,.3);
    color: #223329;
  }
  </style>
</head>
<body class="theme-woodland">
  <div class="game">
    <div class="header">
      <h1>🍄 Fungidentification</h1>
      <div class="sub">Test your mycology knowledge in nature's classroom</div>
    </div>

    <!-- HUD (hidden until game) -->
    <div id="hud" class="hud">
      <div class="box">
        <div class="label">Score</div>
        <div id="score" class="value">0</div>
      </div>
      <div class="box">
        <div class="label">Question</div>
        <div id="questionCounter" class="value">0 / 30</div>
      </div>
    </div>

    <!-- Start -->
    <section id="start" class="screen active">
      <h2 style="text-align:center;margin:10px 0 6px;">Welcome to the Mushroom ID Challenge!</h2>

      <div class="intro">
        <p>You can choose a quiz of <strong>10</strong>, <strong>20</strong> or <strong>30</strong> multiple choice questions. There will be 2–4 photos of a species in each round (taken from a single iNaturalist observation).</p>
        <p>There are four difficulty levels:</p>
		<p><strong>Beginner</strong> - a friendly mode with a small set of iconic species</p>
		<p><strong>Novice</strong> - a slightly larger range of species</p>
		<p><strong>Intermediate</strong> - the full pool of fungi with a more challenging set of possible answers</p>
		<p><strong>Expert</strong> - two new question formats which make this much more difficult</p>
		<p>If the photos are too poor in quality, you can click <em>New Photos</em> to load another observation of the same species. Per 10 questions, Beginners get 3 <em>New Photos</em> uses, Novices get 2 and Intermediates/Experts get 1.</p>
        <p>iNaturalist is a wonderful citizen-science website, but not all observations are guaranteed to be correct. This quiz is intended to be a fun learning tool so should be treated as more of a guide than gospel. </p>You can review all of your answers and the observations at the end. Good luck!</p>
      </div>

      <!-- QUIZ LENGTH row (above difficulty) -->
      <div class="difficulty" id="lengthRow" style="margin-top:6px">
        <button class="diff-btn len-btn active" data-questions="10">10 Questions</button>
        <button class="diff-btn len-btn" data-questions="20">20 Questions</button>
        <button class="diff-btn len-btn" data-questions="30">30 Questions</button>
      </div>

      <!-- Difficulty row (4 levels: Beginner, Novice, Intermediate, Expert) -->
      <div class="difficulty" id="difficultyRow">
        <button class="diff-btn active" data-difficulty="beginner">Beginner</button>
        <button class="diff-btn" data-difficulty="novice">Novice</button>
        <button class="diff-btn" data-difficulty="intermediate">Intermediate</button>
        <button class="diff-btn" data-difficulty="expert">Expert</button>
      </div>
      <!-- Scientific Mode toggle -->
      <div class="difficulty" id="scientificRow" style="margin-top:0; align-items:center;">
        <label class="switch">
          <input type="checkbox" id="scientificToggle">
          <span class="slider"></span>
        </label>
        <div class="sci-copy">
          <span class="sci-title">Scientific Mode</span>
          <span class="sci-desc">Want double points? This mode only shows Latin names in the answers.</span>
        </div>
      </div>

      <div style="text-align:center;">
        <button id="startBtn" class="btn">Start Game</button>
      </div>

      <div class="copyright-note">
        © 2025 Theo Bird — Code & design by Theo Bird.
        Photos © their iNaturalist contributors under Creative Commons licenses.
      </div>
    </section>

    <!-- Loading -->
    <section id="loading" class="screen">
      <h2 style="text-align:center;margin-bottom:10px;">Loading mushroom data…</h2>
      <div style="text-align:center;color:var(--muted)">Foraging for fungi on iNaturalist…</div>
    </section>

    <!-- Game -->
    <section id="game" class="screen">
      <div id="gameContent" class="game-content-wrapper">
        <h2 id="questionText" style="text-align:center; margin-bottom: 12px; display:none;"></h2>
        <div class="image-grid" id="imageGrid"></div>

        <div class="actions">
          <button id="newPhotosBtn" style="display:none">New Photos</button>
        </div>

        <div id="answers" class="answers"></div>
      </div>
    </section>

    <!-- Results -->
    <section id="results" class="screen">
      <h2 style="text-align:center;margin:10px 0 16px;">Quiz complete!</h2>
      <div style="text-align:center;">
        <div id="resultsDifficulty" class="difficulty-pill"></div>
      </div>
      <div style="text-align:center">
        <p style="font-size:1.25rem; margin:0;">Final Score: <span id="finalScore">0</span> / <span id="finalScoreTotal">300</span></p>
      </div>

      <h3 style="margin:18px 0 10px; text-align:center; color:var(--ink-2);">
        Let’s review your answers below:
      </h3>

      <div class="review-wrap">
        <div class="table-scroll">
<table class="review-table" id="reviewTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Fungi</th>
              <th>Correct?</th>
              <th>Your Answer</th>
              <th>iNaturalist observation(s)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
</div>
      </div>

      <div style="text-align:center; margin-top:14px;">
        <button id="playAgainBtn" class="btn">Play again</button>
      </div>
    </section>
  </div>

  <!-- Error modal -->
  <div id="errorModal" class="modal">
    <div class="card">
      <h3>Oops! Something went wrong</h3>
      <p id="errorMsg" style="color:#c9302c; margin:10px 0 16px;">Could not load the first mushroom question.</p>
      <button id="retryBtn" class="btn">Try again</button>
    </div>
  </div>

  <script>
    /* ---------------- DOM & state ---------------- */
    const $ = sel => document.querySelector(sel);
    const hud = $('#hud');
    const screens = { start: $('#start'), loading: $('#loading'), game: $('#game'), results: $('#results') };
    const scoreEl = $('#score'), qEl = $('#questionCounter');
    const imageGrid = $('#imageGrid'), answersEl = $('#answers');
    const newBtn = $('#newPhotosBtn');
    const diffButtons = [...document.querySelectorAll('#difficultyRow .diff-btn')];
    const lenButtons  = [...document.querySelectorAll('#lengthRow .len-btn')];

    const state = {
      difficulty: 'beginner',
      scientificMode: false,  // default
      questionType: 'classic',
      score: 0, q: 0, total: 10,
      isGameActive: false,
      seen: new Set(),
      newPhotosUsed: false,   // used in THIS question
      newPhotosLeft: 3,       // total remaining for the game (set at start from length+difficulty)
      current: null,
      review: [],
      questionTypeQueue: []
    };

    /* ------------- species (names only; ids resolved at runtime) ------------- */
    const mushroomSpecies = [
      // AMANITA
      { id: 48715,  name: "Fly Agaric",            scientific: "Amanita muscaria",      genus: "Amanita",    category: "Amanita" },
      { id: 53778,  name: "Death Cap",             scientific: "Amanita phalloides",    genus: "Amanita",    category: "Amanita" },
      { id: 67661,  name: "The Blusher",           scientific: "Amanita rubescens",     genus: "Amanita",    category: "Amanita" },
      { id: 49917,  name: "Panther Cap",           scientific: "Amanita pantherina",    genus: "Amanita",    category: "Amanita" },
      { id: 63271,  name: "False Death Cap",       scientific: "Amanita citrina",       genus: "Amanita",    category: "Amanita" },
      { id: 58685,  name: "Destroying Angel",      scientific: "Amanita virosa",        genus: "Amanita",    category: "Amanita" },
      { id: 350033, name: "Orange Grisette",       scientific: "Amanita crocea",        genus: "Amanita",    category: "Amanita" },

      // AGARICUS
      { id: 143563, name: "Field Mushroom",        scientific: "Agaricus campestris",   genus: "Agaricus",   category: "Agaricus" },
      { id: 118394, name: "Yellow Stainer",        scientific: "Agaricus xanthodermus", genus: "Agaricus",   category: "Agaricus" },
      { id: 58699,  name: "Horse Mushroom",        scientific: "Agaricus arvensis",     genus: "Agaricus",   category: "Agaricus" },
      { id: 58696,  name: "Pavement Mushroom",     scientific: "Agaricus bitorquis",    genus: "Agaricus",   category: "Agaricus" },
      { id: 60506,  name: "Scaly Wood Mushroom",   scientific: "Agaricus silvaticus",   genus: "Agaricus",   category: "Agaricus" },
      { id: 58646,  name: "The Prince",            scientific: "Agaricus augustus",     genus: "Agaricus",   category: "Agaricus" },

      // PLEUROTUS / SARCOMYXA
      { id: 48530,  name: "Oyster Mushroom",       scientific: "Pleurotus ostreatus",          genus: "Pleurotus",  category: "Pleurotus" },
      { id: 120469, name: "Pale Oyster",           scientific: "Pleurotus pulmonarius",        genus: "Pleurotus",  category: "Pleurotus" },
      { id: 125425, name: "Veiled Oyster",         scientific: "Pleurotus dryinus",            genus: "Pleurotus",  category: "Pleurotus" },
      { id: 125683, name: "Golden Oyster",         scientific: "Pleurotus citrinopileatus",    genus: "Pleurotus",  category: "Pleurotus" },
      { id: 54635,  name: "Olive Oysterling",      scientific: "Sarcomyxa serotina",            genus: "Sarcomyxa",  category: "Pleurotus" },

      // WAXCAPS
      { id: 55245,  name: "Scarlet Waxcap",        scientific: "Hygrocybe coccinea",     genus: "Hygrocybe",  category: "Waxcaps" },
      { id: 51869,  name: "Crimson Waxcap",        scientific: "Hygrocybe punicea",      genus: "Hygrocybe",  category: "Waxcaps" },
      { id: 128868, name: "Blackening Waxcap",     scientific: "Hygrocybe conica",       genus: "Hygrocybe",  category: "Waxcaps" },
      { id: 63475,  name: "Parrot Waxcap",         scientific: "Gliophorus psittacinus", genus: "Gliophorus", category: "Waxcaps" },
      { id: 55240,  name: "Meadow Waxcap",         scientific: "Cuphophyllus pratensis", genus: "Cuphophyllus",category: "Waxcaps" },
      { id: 524919, name: "Heath Waxcap",          scientific: "Gliophorus laetus",      genus: "Gliophorus", category: "Waxcaps" },

      // BOLETES
      { id: 48701,  name: "Penny Bun (Cep)",       scientific: "Boletus edulis",              genus: "Boletus",     category: "Boletes" },
      { id: 53903,  name: "Bay Bolete",            scientific: "Imleria badia",               genus: "Imleria",     category: "Boletes" },
      { id: 53478,  name: "Slippery Jack",         scientific: "Suillus luteus",              genus: "Suillus",     category: "Boletes" },
      { id: 63232,  name: "Birch Bolete",          scientific: "Leccinum scabrum",            genus: "Leccinum",    category: "Boletes" },
      { id: 54163,  name: "Red Cracking Bolete",   scientific: "Xerocomellus chrysenteron",   genus: "Xerocomellus",category: "Boletes" },
      { id: 125740, name: "Suede Bolete",          scientific: "Xerocomus subtomentosus",     genus: "Xerocomus",   category: "Boletes" },
      { id: 63489,  name: "Bitter Bolete",         scientific: "Tylopilus felleus",           genus: "Tylopilus",   category: "Boletes" },
      { id: 553909, name: "Scarletina Bolete",     scientific: "Neoboletus luridiformis",     genus: "Neoboletus",  category: "Boletes" },
      { id: 343661, name: "Orange Birch Bolete",   scientific: "Leccinum versipelle",         genus: "Leccinum",    category: "Boletes" },
      { id: 179065, name: "Weeping Bolete",        scientific: "Suillus granulatus",          genus: "Suillus",     category: "Boletes" },

      // MYCENA
      { id: 63460,  name: "Bleeding Fairy Helmet", scientific: "Mycena haematopus",    genus: "Mycena",    category: "Mycena" },
      { id: 63446,  name: "Common Bonnet",         scientific: "Mycena galericulata",  genus: "Mycena",    category: "Mycena" },
      { id: 63471,  name: "Clustered Bonnet",      scientific: "Mycena inclinata",     genus: "Mycena",    category: "Mycena" },
      { id: 63478,  name: "Lilac Bonnet",          scientific: "Mycena pura",          genus: "Mycena",    category: "Mycena" },
      { id: 566411, name: "Saffrondrop Bonnet",    scientific: "Mycena crocata",       genus: "Mycena",    category: "Mycena" },

      // RUSSULA
      { id: 194437, name: "Charcoal Burner",       scientific: "Russula cyanoxantha", genus: "Russula",   category: "Russula" },
      { id: 56079,  name: "The Sickener",          scientific: "Russula emetica",      genus: "Russula",   category: "Russula" },
      { id: 49446,  name: "Beechwood Sickener",    scientific: "Russula nobilis",      genus: "Russula",   category: "Russula" },
      { id: 63188,  name: "Ochre Brittlegill",     scientific: "Russula ochroleuca",   genus: "Russula",   category: "Russula" },
      { id: 210270, name: "Purple Brittlegill",    scientific: "Russula atropurpurea", genus: "Russula",   category: "Russula" },
      { id: 56081,  name: "Greencracked Brittlegill",scientific:"Russula virescens",   genus: "Russula",   category: "Russula" },
      { id: 125576, name: "Powdery Brittlegill",   scientific: "Russula parazurea",    genus: "Russula",   category: "Russula" },
      { id: 416072, name: "Stinking Brittlegill",  scientific: "Russula foetens",      genus: "Russula",   category: "Russula" },

      // BRACKETS & POLYPORES
      { id: 47392,  name: "Turkey Tail",           scientific: "Trametes versicolor",  genus: "Trametes",  category: "Brackets & Polypores" },
      { id: 125434, name: "Artist's Bracket",      scientific: "Ganoderma applanatum", genus: "Ganoderma", category: "Brackets & Polypores" },
      { id: 124459, name: "Red-belted Polypore",   scientific: "Fomitopsis pinicola",  genus: "Fomitopsis",category: "Brackets & Polypores" },
      { id: 83490,  name: "Birch Polypore",        scientific: "Fomitopsis betulina",  genus: "Fomitopsis",category: "Brackets & Polypores" },
      { id: 410641, name: "Lumpy Bracket",         scientific: "Trametes gibbosa",     genus: "Trametes",  category: "Brackets & Polypores" },
      { id: 118038, name: "Smoky Bracket",         scientific: "Bjerkandera adusta",   genus: "Bjerkandera",category:"Brackets & Polypores" },
      { id: 47923,  name: "Hoof Fungus",           scientific: "Fomes fomentarius",    genus: "Fomes",     category: "Brackets & Polypores" },
      { id: 55653,  name: "Beefsteak Fungus",      scientific: "Fistulina hepatica",   genus: "Fistulina", category: "Brackets & Polypores" },
      { id: 55155,  name: "Purplepore Bracket",    scientific: "Trichaptum abietinum", genus: "Trichaptum",category:"Brackets & Polypores" },
      { id: 118063, name: "Crimped Gill",          scientific: "Plicaturopsis crispa", genus: "Plicaturopsis",category:"Brackets & Polypores" },
      { id: 55265,  name: "Chicken of the Woods",  scientific: "Laetiporus sulphureus", genus: "Laetiporus", category: "Brackets & Polypores" },
      { id: 84613,  name: "Hen of the Woods",      scientific: "Grifola frondosa",      genus: "Grifola",    category: "Brackets & Polypores" },
      { id: 157989, name: "Giant (Blackening) Polypore", scientific: "Meripilus giganteus",   genus: "Meripilus",  category: "Brackets & Polypores" },
      { id: 118078, name: "Dryad's Saddle",              scientific: "Polyporus squamosus",   genus: "Polyporus",  category: "Brackets & Polypores" },
      { id: 124102, name: "Blushing Bracket",            scientific: "Daedaleopsis confragosa",genus: "Daedaleopsis",category:"Brackets & Polypores" },
      { id: 55501,  name: "Hairy Curtain Crust",         scientific: "Stereum hirsutum",      genus: "Stereum",    category: "Brackets & Polypores" },

      // CHANTERELLES & ALLIES
      { id: 47347,  name: "Golden Chanterelle",    scientific: "Cantharellus cibarius",  genus: "Cantharellus",category: "Chanterelles & Allies" },
      { id: 175283, name: "Horn of Plenty",        scientific: "Craterellus cornucopioides",genus:"Craterellus",category:"Chanterelles & Allies" },
      { id: 350511, name: "Winter Chanterelle",    scientific: "Craterellus tubaeformis",genus:"Craterellus", category:"Chanterelles & Allies" },
      { id: 127394, name: "False Chanterelle",     scientific: "Hygrophoropsis aurantiaca",genus:"Hygrophoropsis",category:"Chanterelles & Allies" },
      { id: 58857,  name: "Hedgehog Fungus",       scientific: "Hydnum repandum",        genus: "Hydnum",    category: "Chanterelles & Allies" },
      { id: 124699, name: "Scaly Chanterelle",     scientific: "Turbinellus floccosus",  genus: "Turbinellus",category:"Chanterelles & Allies" },

      // FUNNELS & GRASSLAND
      { id: 123623, name: "Clouded Funnel",        scientific: "Clitocybe nebularis",      genus: "Clitocybe",    category: "Funnels & Grassland" },
      { id: 119227, name: "Trooping Funnel",       scientific: "Infundibulicybe geotropa", genus: "Infundibulicybe",category:"Funnels & Grassland" },
      { id: 55239,  name: "Fairy Ring Champignon", scientific: "Marasmius oreades",        genus: "Marasmius",   category: "Funnels & Grassland" },
      { id: 120230, name: "St. George's Mushroom", scientific: "Calocybe gambosa",         genus: "Calocybe",    category: "Funnels & Grassland" },
      { id: 125429, name: "Brown Mottlegill",      scientific: "Panaeolina foenisecii",    genus: "Panaeolina",  category: "Inkcaps and LBMs" },
      { id: 48526,  name: "Common Inkcap",         scientific: "Coprinopsis atramentaria", genus: "Coprinopsis", category: "Inkcaps and LBMs" },
      { id: 55453,  name: "Magpie Inkcap",         scientific: "Coprinopsis picacea",      genus: "Coprinopsis", category: "Inkcaps and LBMs" },
      { id: 54025,  name: "Liberty Cap",           scientific: "Psilocybe semilanceata",   genus: "Psilocybe",   category: "Inkcaps and LBMs" },
      { id: 125630, name: "Common Conecap",        scientific: "Conocybe tenera",          genus: "Conocybe",    category: "Inkcaps and LBMs" },
      { id: 56318,  name: "Glistening Inkcap",     scientific: "Coprinellus micaceus",     genus: "Coprinellus", category: "Inkcaps and LBMs" },
      { id: 47652,  name: "Common Puffball",       scientific: "Lycoperdon perlatum",      genus: "Lycoperdon",  category: "Funnels & Grassland" },
      { id: 54026,  name: "Shaggy Inkcap",         scientific: "Coprinus comatus",         genus: "Coprinus",    category: "Funnels & Grassland" },
      { id: 127636, name: "Shaggy Parasol",        scientific: "Chlorophyllum rhacodes",   genus: "Chlorophyllum",category:"Funnels & Grassland" },
      { id: 47468,  name: "The Parasol",           scientific: "Macrolepiota procera",     genus: "Macrolepiota",category:"Funnels & Grassland" },
      { id: 921916, name: "Common Funnel",         scientific: "Infundibulicybe gibba",    genus: "Infundibulicybe", category: "Funnels & Grassland" },
      { id: 841424, name: "Tawny Funnel",          scientific: "Paralepista flaccida",     genus: "Paralepista", category: "Funnels & Grassland" },

      // CUP & OTHER SAPROTROPHS
      { id: 119945, name: "Orange Peel Fungus",    scientific: "Aleuria aurantia",        genus: "Aleuria",    category: "Cup & other Saprotrophs" },
      { id: 119224, name: "King Alfred's Cakes",   scientific: "Daldinia concentrica",    genus: "Daldinia",   category: "Cup & other Saprotrophs" },
      { id: 84740,  name: "Scarlet Elfcup",        scientific: "Sarcoscypha austriaca",   genus: "Sarcoscypha",category: "Cup & other Saprotrophs" },
      { id: 55655,  name: "Yellow Stagshorn",      scientific: "Calocera viscosa",        genus: "Calocera",  category: "Cup & other Saprotrophs" },
      { id: 117556, name: "Jelly Ear",             scientific: "Auricularia auricula-judae",genus:"Auricularia",category:"Cup & other Saprotrophs" },
      { id: 54743,  name: "Yellow Brain",          scientific: "Tremella mesenterica",    genus: "Tremella",  category: "Cup & other Saprotrophs" },

      // WOODLAND FUNGI
      { id: 47346,  name: "Funeral Bell",          scientific: "Galerina marginata",      genus: "Galerina",  category: "Woodland Fungi" },
      { id: 56086,  name: "False Morel",           scientific: "Gyromitra esculenta",     genus: "Gyromitra", category: "Woodland Fungi" },
      { id: 54844,  name: "Honey Fungus",        scientific: "Armillaria mellea",       genus: "Armillaria",category: "Woodland Fungi" },
      { id: 60448,  name: "Sheathed Woodtuft",     scientific: "Kuehneromyces mutabilis", genus: "Kuehneromyces",category:"Woodland Fungi" },
      { id: 417180, name: "Common Rustgill",       scientific: "Gymnopilus penetrans",    genus: "Gymnopilus",category: "Woodland Fungi" },
      { id: 56021,  name: "Velvet Shank",          scientific: "Flammulina velutipes",    genus: "Flammulina",category: "Woodland Fungi" },
      { id: 481482, name: "Wrinkled Peach",        scientific: "Rhodotus palmatus",       genus: "Rhodotus",  category: "Woodland Fungi" },
      { id: 55964,  name: "Porcelain Fungus",      scientific: "Oudemansiella mucida",    genus: "Oudemansiella", category: "Woodland Fungi" },
      { id: 58682,  name: "Morel",                 scientific: "Morchella esculenta",     genus: "Morchella", category: "Woodland Fungi" },
      { id: 48767,  name: "Sulphur Tuft",          scientific: "Hypholoma fasciculare",   genus: "Hypholoma", category: "Woodland Fungi" },
      { id: 63433,  name: "Golden Scalycap",       scientific: "Pholiota aurivella",      genus: "Pholiota",  category: "Woodland Fungi" },

      // DISTINCTIVE ODDBALLS
      { id: 53715,  name: "Lion's Mane",           scientific: "Hericium erinaceus",      genus: "Hericium",  category: "Distinctive Oddballs" },
      { id: 57343,  name: "Giant Puffball",        scientific: "Calvatia gigantea",       genus: "Calvatia",  category: "Distinctive Oddballs" },
      { id: 469901, name: "Devil's Fingers",       scientific: "Clathrus archeri",        genus: "Clathrus",  category: "Distinctive Oddballs" },
      { id: 53764,  name: "Dead Man's Fingers",    scientific: "Xylaria polymorpha",      genus: "Xylaria",   category: "Distinctive Oddballs" },
      { id: 55267,  name: "Candlesnuff",           scientific: "Xylaria hypoxylon",       genus: "Xylaria",   category: "Distinctive Oddballs" },
      { id: 63014,  name: "Cauliflower Fungus",    scientific: "Sparassis crispa",        genus: "Sparassis", category: "Distinctive Oddballs" },
      { id: 54594,  name: "Stinkhorn",             scientific: "Phallus impudicus",       genus: "Phallus",   category: "Distinctive Oddballs" },

      // BLEWITS & LOOKALIKES
      { id: 119152, name: "Wood Blewit",           scientific: "Lepista nuda",            genus: "Lepista",   category: "Blewits & Lookalikes" },
      { id: 1039723,name: "Field Blewit",          scientific: "Lepista saeva",           genus: "Lepista",   category: "Blewits & Lookalikes" },
      { id: 417492, name: "Lilac Fibrecap",        scientific: "Inocybe lilacina",        genus: "Inocybe",   category: "Blewits & Lookalikes" },
      { id: 63509,  name: "Amethyst Deceiver",     scientific: "Laccaria amethystina",    genus: "Laccaria",  category: "Blewits & Lookalikes" },
      { id: 55254,  name: "Bruising Webcap",       scientific: "Cortinarius purpurascens",genus: "Cortinarius",category:"Blewits & Lookalikes" },

      // LACTARIUS category
      { id: 155197, name: "Saffron Milkcap",       scientific: "Lactarius deliciosus",    genus: "Lactarius", category: "Lactarius" },
      { id: 155080, name: "Oak Milkcap",           scientific: "Lactarius quietus",       genus: "Lactarius", category: "Lactarius" },
      { id: 351313, name: "Woolly Milkcap",        scientific: "Lactarius torminosus",    genus: "Lactarius", category: "Lactarius" },
      { id: 63526,  name: "Fleecy Milkcap",        scientific: "Lactifluus vellereus",    genus: "Lactifluus",category: "Lactarius" },
      { id: 382886, name: "Ugly Milkcap",          scientific: "Lactarius turpis",        genus: "Lactarius", category: "Lactarius" },

      // === Added species & new categories ===
      { id: 1039724,  name: "White Dapperling", scientific: "Leucoagaricus leucothites", genus: "Leucoagaricus", category: "Amanita" },
      { id: 1039725,  name: "Oak Mazegill", scientific: "Daedalea quercina", genus: "Daedalea", category: "Brackets & Polypores" },
      { id: 1039726,  name: "Common Earthball", scientific: "Scleroderma citrinum", genus: "Scleroderma", category: "Funnels & Grassland" },
      { id: 1039727,  name: "Beech Milkcap", scientific: "Lactarius blennius", genus: "Lactarius", category: "Lactarius" },
      { id: 1039728,  name: "White Knight", scientific: "Tricholoma album", genus: "Tricholoma", category: "Agaricus" },
      { id: 1039729,  name: "Blackening Brittlegill", scientific: "Russula nigricans", genus: "Russula", category: "Russula" },
      { id: 1039730,  name: "Geranium Brittlegill", scientific: "Russula fellea", genus: "Russula", category: "Russula" },
      { id: 1039731,  name: "Burnt Knight", scientific: "Tricholoma ustale", genus: "Tricholoma", category: "Webcaps & Darker" },
      { id: 1039732,  name: "Stocking Webcap", scientific: "Cortinarius torvus", genus: "Cortinarius", category: "Webcaps & Darker" },
      { id: 1039733,  name: "Plums and Custard", scientific: "Tricholomopsis rutilans", genus: "Tricholomopsis", category: "Webcaps & Darker" },
      { id: 1039734,  name: "Dappled Webcap", scientific: "Cortinarius bolaris", genus: "Cortinarius", category: "Webcaps & Darker" },
      { id: 1039735,  name: "Deadly Webcap", scientific: "Cortinarius rubellus", genus: "Cortinarius", category: "Webcaps & Darker" },
      { id: 1039736,  name: "Deadly Fibrecap", scientific: "Inosperma erubescens", genus: "Inosperma", category: "Webcaps & Darker" },
      { id: 1039737,  name: "Dewdrop Mottlegill", scientific: "Panaeolus acuminatus", genus: "Panaeolus", category: "Inkcaps and LBMs" },
    ];;
    const speciesList = mushroomSpecies;

    /* Beginner curated set — easiest iconic species */
    const beginnerScientificSet = new Set([
      "Laetiporus sulphureus","Grifola frondosa","Amanita muscaria","Boletus edulis",
      "Trametes versicolor","Fomes fomentarius","Cantharellus cibarius","Hydnum repandum",
      "Craterellus cornucopioides","Sarcoscypha austriaca","Morchella esculenta","Hericium erinaceus",
      "Pleurotus ostreatus","Coprinus comatus","Macrolepiota procera","Calocera viscosa","Lycoperdon perlatum"
    ]);
    const beginnerSpecies = speciesList.filter(s => beginnerScientificSet.has(s.scientific));

/* -------- NOVICE difficulty: Beginner set + these extras -------- */
const noviceExtras = [
  { id: 53778,  name: "Death Cap",             scientific: "Amanita phalloides",    genus: "Amanita",    category: "Amanita" },
  { id: 58685,  name: "Destroying Angel",      scientific: "Amanita virosa",        genus: "Amanita",    category: "Amanita" },
  { id: 118394, name: "Yellow Stainer",        scientific: "Agaricus xanthodermus", genus: "Agaricus",   category: "Agaricus" },
  { id: 58646,  name: "The Prince",            scientific: "Agaricus augustus",     genus: "Agaricus",   category: "Agaricus" },
  { id: 125683, name: "Golden Oyster",         scientific: "Pleurotus citrinopileatus",    genus: "Pleurotus",  category: "Pleurotus" },
  { id: 51869,  name: "Crimson Waxcap",        scientific: "Hygrocybe punicea",      genus: "Hygrocybe",  category: "Waxcaps" },
  { id: 63475,  name: "Parrot Waxcap",         scientific: "Gliophorus psittacinus", genus: "Gliophorus", category: "Waxcaps" },
  { id: 53903,  name: "Bay Bolete",            scientific: "Imleria badia",               genus: "Imleria",     category: "Boletes" },
  { id: 63232,  name: "Birch Bolete",          scientific: "Leccinum scabrum",            genus: "Leccinum",    category: "Boletes" },
  { id: 54163,  name: "Red Cracking Bolete",   scientific: "Xerocomellus chrysenteron",   genus: "Xerocomellus",category: "Boletes" },
  { id: 63446,  name: "Common Bonnet",         scientific: "Mycena galericulata",  genus: "Mycena",    category: "Mycena" },
  { id: 63471,  name: "Clustered Bonnet",      scientific: "Mycena inclinata",     genus: "Mycena",    category: "Mycena" },
  { id: 194437, name: "Charcoal Burner",       scientific: "Russula cyanoxantha", genus: "Russula",   category: "Russula" },
  { id: 49446,  name: "Beechwood Sickener",    scientific: "Russula nobilis",      genus: "Russula",   category: "Russula" },
  { id: 63188,  name: "Ochre Brittlegill",     scientific: "Russula ochroleuca",   genus: "Russula",   category: "Russula" },
  { id: 124459, name: "Red-belted Polypore",   scientific: "Fomitopsis pinicola",  genus: "Fomitopsis",category: "Brackets & Polypores" },
  { id: 83490,  name: "Birch Polypore",        scientific: "Fomitopsis betulina",  genus: "Fomitopsis",category: "Brackets & Polypores" },
  { id: 410641, name: "Lumpy Bracket",         scientific: "Trametes gibbosa",     genus: "Trametes",  category: "Brackets & Polypores" },
  { id: 55653,  name: "Beefsteak Fungus",      scientific: "Fistulina hepatica",   genus: "Fistulina", category: "Brackets & Polypores" },
  { id: 157989, name: "Giant (Blackening) Polypore", scientific: "Meripilus giganteus",   genus: "Meripilus",  category: "Brackets & Polypores" },
  { id: 118078, name: "Dryad's Saddle",              scientific: "Polyporus squamosus",   genus: "Polyporus",  category: "Brackets & Polypores" },
  { id: 350511, name: "Winter Chanterelle",    scientific: "Craterellus tubaeformis",genus:"Craterellus", category:"Chanterelles & Allies" },
  { id: 127394, name: "False Chanterelle",     scientific: "Hygrophoropsis aurantiaca",genus:"Hygrophoropsis",category:"Chanterelles & Allies" },
  { id: 119227, name: "Trooping Funnel",       scientific: "Infundibulicybe geotropa", genus: "Infundibulicybe",category:"Funnels & Grassland" },
  { id: 120230, name: "St. George's Mushroom", scientific: "Calocybe gambosa",         genus: "Calocybe",    category: "Funnels & Grassland" },
  { id: 48526,  name: "Common Inkcap",         scientific: "Coprinopsis atramentaria", genus: "Coprinopsis", category: "Inkcaps and LBMs" },
  { id: 55453,  name: "Magpie Inkcap",         scientific: "Coprinopsis picacea",      genus: "Coprinopsis", category: "Inkcaps and LBMs" },
  { id: 54025,  name: "Liberty Cap",           scientific: "Psilocybe semilanceata",   genus: "Psilocybe",   category: "Inkcaps and LBMs" },
  { id: 119945, name: "Orange Peel Fungus",    scientific: "Aleuria aurantia",        genus: "Aleuria",    category: "Cup & other Saprotrophs" },
  { id: 119224, name: "King Alfred's Cakes",   scientific: "Daldinia concentrica",    genus: "Daldinia",   category: "Cup & other Saprotrophs" },
  { id: 117556, name: "Jelly Ear",             scientific: "Auricularia auricula-judae",genus:"Auricularia",category:"Cup & other Saprotrophs" },
  { id: 54743,  name: "Yellow Brain",          scientific: "Tremella mesenterica",    genus: "Tremella",  category: "Cup & other Saprotrophs" },
  { id: 47346,  name: "Funeral Bell",          scientific: "Galerina marginata",      genus: "Galerina",  category: "Woodland Fungi" },
  { id: 56086,  name: "False Morel",           scientific: "Gyromitra esculenta",     genus: "Gyromitra", category: "Woodland Fungi" },
  { id: 54844,  name: "Honey Fungus",          scientific: "Armillaria mellea",       genus: "Armillaria",category: "Woodland Fungi" },
  { id: 481482, name: "Wrinkled Peach",        scientific: "Rhodotus palmatus",       genus: "Rhodotus",  category: "Woodland Fungi" },
  { id: 48767,  name: "Sulphur Tuft",          scientific: "Hypholoma fasciculare",   genus: "Hypholoma", category: "Woodland Fungi" },
  { id: 57343,  name: "Giant Puffball",        scientific: "Calvatia gigantea",       genus: "Calvatia",  category: "Distinctive Oddballs" },
  { id: 469901, name: "Devil's Fingers",       scientific: "Clathrus archeri",        genus: "Clathrus",  category: "Distinctive Oddballs" },
  { id: 53764,  name: "Dead Man's Fingers",    scientific: "Xylaria polymorpha",      genus: "Xylaria",   category: "Distinctive Oddballs" },
  { id: 63014,  name: "Cauliflower Fungus",    scientific: "Sparassis crispa",        genus: "Sparassis", category: "Distinctive Oddballs" },
  { id: 54594,  name: "Stinkhorn",             scientific: "Phallus impudicus",       genus: "Phallus",   category: "Distinctive Oddballs" },
  { id: 119152, name: "Wood Blewit",           scientific: "Lepista nuda",            genus: "Lepista",   category: "Blewits & Lookalikes" },
  { id: 63509,  name: "Amethyst Deceiver",     scientific: "Laccaria amethystina",    genus: "Laccaria",  category: "Blewits & Lookalikes" },
];

/* Novice = Beginner + extras (deduped by id to avoid duplicates) */
const noviceSpecies = Array.from(
  new Map([...beginnerSpecies, ...noviceExtras].map(s => [s.id, s])).values()
);
const advancedSpecies = speciesList.filter(s => !beginnerScientificSet.has(s.scientific) && s.category !== "Cup & other Saprotrophs");


    /* ---------------- helpers ---------------- */
    const ALLOWED = new Set(['cc0','cc-by','cc-by-sa','cc-by-nd','cc-by-nc','cc-by-nc-sa','cc-by-nc-nd']);
    const recentObs = new Map();
    const perPage = 50; // page size for RG queue

    /* ---- RG-only per-species queue with skip-if-empty + persistence (Option D) ---- */

    // Per-user seed for deterministic page offsets (Option B)
    function getUserSeed(){
      let s = localStorage.getItem('userSeed');
      if (!s){ s = String(Math.floor(Math.random()*2147483647)); localStorage.setItem('userSeed', s); }
      return s;
    }
    function hashStr(str){
      // simple FNV-1a 32-bit hash
      let h = 2166136261;
      for (let i=0; i<str.length; i++){ h ^= str.charCodeAt(i); h = (h * 16777619) >>> 0; }
      return h >>> 0;
    }
const speciesQueues = new Map(); // scientific -> { page, items: [], exhausted, _loaded:false, _backlog:[] }
    function getQueue(scientific){
      if (!speciesQueues.has(scientific)){
        speciesQueues.set(scientific, { page: (1 + (hashStr(getUserSeed() + '|' + scientific) % 8)), items: [], exhausted: false, _loaded: false, _backlog: [] });
      }
      return speciesQueues.get(scientific);
    }
    async function fetchRGPage(taxonId, page, perPage){
      const qs = new URLSearchParams({
        taxon_id: String(taxonId),
        has: 'photos',
        quality_grade: 'research',
        per_page: String(perPage),
        page: String(page),
        order: 'desc',
        order_by: 'observed_on',
        fields:
          'results.id,results.uri,results.taxon.id,' +
          'results.photos.id,results.photos.url,results.photos.medium_url,results.photos.large_url,' +
          'results.photos.attribution,results.photos.license_code'
      });
      const r = await fetch(`https://api.inaturalist.org/v1/observations?${qs}`);
      if (!r.ok) return [];
      const j = await r.json();
      const results = Array.isArray(j.results) ? j.results : [];
      // Keep only observations with at least 2 allowed-license photos
      return results.filter(o => {
        const good = (o.photos || []).filter(p => ALLOWED.has(String(p.license_code||'').toLowerCase()));
        return good.length >= 2;
      });
    }
    // Persistence helpers (store compact list of observation IDs per species)
    const RGQ_MAX = 30;
    function qKey(scientific){ return `rgQueue:${scientific}`; }
    function loadPersistedIds(scientific){
      try { const raw = localStorage.getItem(qKey(scientific)); return raw ? JSON.parse(raw) : []; }
      catch(e){ return []; }
    }
    function saveIds(scientific, ids){
      try {
        const existing = loadPersistedIds(scientific);
        const merged = Array.from(new Set([...(existing||[]), ...ids]));
        localStorage.setItem(qKey(scientific), JSON.stringify(merged.slice(0, RGQ_MAX)));
      } catch(e){}
    }
    async function ensureQueue(scientific, taxonId, minNeeded=1, attempts=2){
      const q = getQueue(scientific);
      const recent = recentObs.get(scientific) || new Set();
      let tries = 0;
      while (q.items.filter(o => !recent.has(o.id)).length < minNeeded && !q.exhausted && tries < attempts){
        const pageItems = await fetchRGPage(taxonId, q.page, perPage);
        if (!pageItems.length){
          if (tries === 0 && q.page > 1){ q.page = 1; tries++; continue; }
          q.exhausted = true; break; }
        shuffle(pageItems);
        // append non-recent first to maximize freshness
        const fresh = pageItems.filter(o => !recent.has(o.id));
        const rest  = pageItems.filter(o => recent.has(o.id));
        q.items.push(...fresh, ...rest);
        // persist IDs for Option D
        saveIds(scientific, pageItems.map(o=>o.id));
        q.page += 1;
        tries += 1;
      }
    }
    function takeFromQueue(scientific, excludeId=null){
      const q = getQueue(scientific);
      const recent = recentObs.get(scientific) || new Set();
      const idx = q.items.findIndex(o => o.id !== excludeId && !recent.has(o.id));
      if (idx !== -1){ const [pick] = q.items.splice(idx, 1); return pick; }
      // fallback: allow recent if necessary, but still not excludeId
      const anyIdx = q.items.findIndex(o => o.id !== excludeId);
      if (anyIdx !== -1){ const [pick] = q.items.splice(anyIdx, 1); return pick; }
      return null;
    }

    /* ---- Option A: persistent used observation IDs per species (localStorage) ---- */
    const USED_MAX = 50; // keep the last ~50 IDs per species

    function usedKey(scientific){
      return `obsUsed:${scientific}`;
    }
    function getUsedArray(scientific){
      try {
        const raw = localStorage.getItem(usedKey(scientific));
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr.filter(x => Number.isInteger(x)) : [];
      } catch (e) {
        return [];
      }
    }
    function getUsedSet(scientific){
      return new Set(getUsedArray(scientific));
    }
    function rememberUsed(scientific, id){
      if (!id) return;
      const arr = getUsedArray(scientific);
      if (!arr.includes(id)) arr.push(id);
      while (arr.length > USED_MAX) arr.shift();
      try { localStorage.setItem(usedKey(scientific), JSON.stringify(arr)); } catch (e) {}
    }


    function pushRecent(scientific, id, max=10){
      if (!recentObs.has(scientific)) recentObs.set(scientific, new Set());
      const s = recentObs.get(scientific); s.add(id);
      if (s.size > max){ const first = s.values().next().value; s.delete(first); }
    }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]] } return a; }
    function setScreen(name){
      Object.values(screens).forEach(s=>s.classList.remove('active'));
      screens[name].classList.add('active');
      hud.style.display = (name === 'game') ? 'flex' : 'none';
    }
    function updateHud(){ scoreEl.textContent = state.score; qEl.textContent = `${state.q+1} / ${state.total}`; }
    function formatLicense(code){ return code ? String(code).toUpperCase().replace(/_/g,'-') : 'ALL RIGHTS RESERVED'; }

    function cleanAttribution(str){
      let s = (str || '').trim();
      s = s.replace(/^(\(c\)|©)\s*/i,''); // drop leading copyright marker
      s = s.replace(/,\s*(?:some|all|no)\s+rights\s+reserved\s*\(.*?\)\s*$/i,''); // drop rights text
      s = s.replace(/\s+/g,' ').trim();
      return s || 'iNaturalist user';
    }

    async function resolveTaxonId(scientific){
      const key = `inatTaxonId:${scientific}`;
      const cached = localStorage.getItem(key);
      if (cached) return Number(cached);
      const url = `https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(scientific)}&rank=species&is_active=true&per_page=1`;
      const r = await fetch(url); const j = await r.json();
      const id = j?.results?.[0]?.id;
      if (!id) throw new Error(`Could not resolve taxon for ${scientific}`);
      localStorage.setItem(key, String(id));
      return id;
    }

    function bestPhotoUrls(p){
      const med = p.medium_url || (p.url ? p.url.replace('/square.', '/medium.') : null);
      const lg  = p.large_url  || (p.url ? p.url.replace('/square.', '/large.')  : med);
      return { med, lg };
    }


    async function fetchOneObservation(scientific, excludeId=null){
      const taxonId = await resolveTaxonId(scientific);
      const q = getQueue(scientific);

      // Seed persisted backlog once per session
      if (!q._loaded){ q._loaded = true; q._backlog = loadPersistedIds(scientific) || []; }

      // Ensure at least one candidate in the queue
      await ensureQueue(scientific, taxonId, 1, 2);

      // If queue still empty (or only has excluded), try to hydrate a few persisted IDs
      if ((!q.items.length || (q.items.length===1 && q.items[0].id===excludeId)) && q._backlog && q._backlog.length){
        const idsToHydrate = q._backlog.splice(0, 6);
        for (const id of idsToHydrate){
          try {
            const qs = new URLSearchParams({
              id: String(id),
              fields: 'results.id,results.uri,results.photos.id,results.photos.url,results.photos.medium_url,results.photos.large_url,results.photos.attribution,results.photos.license_code'
            });
            const r = await fetch(`https://api.inaturalist.org/v1/observations?${qs}`);
            if (!r.ok) continue;
            const j = await r.json();
            const o = (j.results || [])[0];
            if (!o) continue;
            const good = (o.photos||[]).filter(p => ALLOWED.has(String(p.license_code||'').toLowerCase()));
            if (good.length >= 2) q.items.push(o);
          } catch(e){}
        }
      }

      // Try to take one now
      let pick = takeFromQueue(scientific, excludeId);
      if (pick) return pick;

      // One last attempt: fetch one more page
      await ensureQueue(scientific, taxonId, 1, 1);
      pick = takeFromQueue(scientific, excludeId);
      if (pick) return pick;

      // Option B: let caller skip species if empty
      return null;
    }


    function renderPhotos(observation, species){
      imageGrid.innerHTML = '';
      const good = observation.photos.filter(p => ALLOWED.has(String(p.license_code||'').toLowerCase()));
      const pick = good.slice(0, 3);
      const four = pick.length === 3 ? [...pick, pick[0]] :
                   pick.length === 2 ? [...pick, ...pick] :
                   pick.length === 1 ? [pick[0], pick[0], pick[0], pick[0]] : [];

      four.forEach((p) => {
        const { med, lg } = bestPhotoUrls(p);
        const name = cleanAttribution(p.attribution);
        const card = document.createElement('div');
        card.className = 'img-card';
        card.innerHTML = `
          <div class="img-wrap">
            <img loading="lazy" decoding="async" src="${med}" srcset="${med} 1x, ${lg} 2x" alt="Mushroom photo">
            <div class="credit">
              <span class="name">(c) ${name}</span>
              <span class="license-badge">${formatLicense(p.license_code)}</span>
            </div>
          </div>
        `;
        imageGrid.appendChild(card);
      });
    }

    function renderAnswers(options){
  answersEl.innerHTML = options.map((sp, i)=>{
    const onlyLatin = state.scientificMode === true;
    const label = onlyLatin ? `<em>${sp.scientific}</em>` : `${sp.name}<small><em>${sp.scientific}</em></small>`;
    return `<button class="answer" data-i="${i}" data-id="${sp.id}" data-name="${sp.name}" data-sci="${sp.scientific}">${label}</button>`;
  }).join('');
}
    function renderReview(){
      const tbody = document.querySelector('#reviewTable tbody');
      if (!tbody) return;
      tbody.innerHTML = state.review.map(row => {
        const links = row.uris.map((u, i) =>
          `<a href="${u}" target="_blank" rel="noopener">Observation ${i+1}</a>`
        ).join(' &middot; ');

        let yourAnswerHtml = '';
        if (typeof row.chose === 'object' && row.chose !== null) {
          // It's a species object from a photo choice question
          yourAnswerHtml = `
            <span class="fungus-name">${row.chose.name}</span>
            <span class="fungus-sci"><em>${row.chose.scientific}</em></span>
          `;
        } else {
          // It's a string from a classic or text input question
          yourAnswerHtml = row.chose;
        }

        return `
          <tr>
            <td>${row.n}</td>
            <td>
              <span class="fungus-name">${row.name}</span>
              <span class="fungus-sci"><em>${row.scientific}</em></span>
            </td>
            <td>${row.correct ? '<span class="badge ok">Correct</span>' : '<span class="badge no">Incorrect</span>'}</td>
            <td>${yourAnswerHtml}</td>
            <td>${links}</td>
          </tr>
        `;
      }).join('');
    }

    function refreshNewPhotosBtn(){
      const left = state.newPhotosLeft;
      newBtn.textContent = `New Photos (${left} remaining)`;
      newBtn.disabled = state.newPhotosUsed || left <= 0;
    }

    // Difficulty-aware New Photos quota (per 10 questions)
    function computeNewPhotoQuota(total, difficulty){
      const units = total / 10; // total is 10, 20 or 30
      if (difficulty === 'beginner') return units * 3;
      if (difficulty === 'novice') return units * 2;
      return units * 1; // intermediate & expert
    }

    async function fetchPhotoChoiceData(retryCount = 0) {
      if (retryCount > 3) {
        throw new Error("Failed to fetch photo choice data after multiple retries.");
      }
      const pool = advancedSpecies;
      const remaining = pool.filter(s => !state.seen.has(s.scientific));
      const base = remaining.length ? remaining : pool;
      const correctSpecies = base[Math.floor(Math.random() * base.length)];

      const options = pickOptions(correctSpecies);

      const observationPromises = options.map(species => fetchOneObservation(species.scientific));
      const observations = await Promise.all(observationPromises);

      const validObservations = observations.every(obs => obs !== null);
      if (!validObservations || observations.length < 4) {
        console.error("Could not fetch 4 observations for photo choice question. Retrying...");
        return fetchPhotoChoiceData(retryCount + 1);
      }

      const correctIndex = options.findIndex(s => s.id === correctSpecies.id);

      options.forEach((s, i) => {
        rememberUsed(s.scientific, observations[i].id);
        pushRecent(s.scientific, observations[i].id);
      });
      state.seen.add(correctSpecies.scientific);

      return {
        correctSpecies,
        observations,
        correctIndex,
        options
      };
    }

    function renderPhotoChoiceQuestion(data) {
      const { correctSpecies, observations, correctIndex } = data;

      const questionName = state.scientificMode ? `<em>${correctSpecies.scientific}</em>` : correctSpecies.name;
      const startsWithThe = !state.scientificMode && correctSpecies.name.startsWith('The ');
      const questionTemplate = startsWithThe ? `Which of these shows ${questionName}?` : `Which of these shows a ${questionName}?`;
      $('#questionText').innerHTML = questionTemplate;
      $('#questionText').style.display = 'block';
      imageGrid.style.display = 'none';
      newBtn.style.display = 'none';

      answersEl.innerHTML = '';
      answersEl.className = 'image-grid';

      observations.forEach((obs, index) => {
        const photo = obs.photos[0];
        const { med, lg } = bestPhotoUrls(photo);
        const name = cleanAttribution(photo.attribution);
        const card = document.createElement('button');
        card.className = 'img-card answer';
        card.dataset.index = index;
        card.innerHTML = `
          <div class="img-wrap">
            <img loading="lazy" decoding="async" src="${med}" srcset="${med} 1x, ${lg} 2x" alt="Mushroom photo">
            <div class="credit">
              <span class="name">(c) ${name}</span>
              <span class="license-badge">${formatLicense(photo.license_code)}</span>
            </div>
          </div>
        `;
        answersEl.appendChild(card);
      });

      state.current = {
        correct: correctSpecies,
        correctIndex: correctIndex,
        uris: observations.map(o => o.uri),
        options: data.options
      };
    }

    function levenshtein(a, b) {
      if (a.length === 0) return b.length;
      if (b.length === 0) return a.length;
      const matrix = [];
      for (let i = 0; i <= b.length; i++) { matrix[i] = [i]; }
      for (let j = 0; j <= a.length; j++) { matrix[0][j] = j; }
      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          if (b.charAt(i - 1) === a.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1));
          }
        }
      }
      return matrix[b.length][a.length];
    }

    function renderTextInputQuestion(data) {
      const { correct, obs } = data;
      renderPhotos(obs, correct);
      newBtn.style.display = 'inline-flex';
      refreshNewPhotosBtn();

      const placeholder = state.scientificMode ? "Enter Latin name..." : "Enter common or Latin name...";
      answersEl.innerHTML = `
        <div class="text-input-row">
          <input type="text" id="textAnswerInput" class="answer text-input" placeholder="${placeholder}">
          <button id="textAnswerSubmit" class="btn answer">Submit</button>
        </div>
      `;
      answersEl.className = 'answers';
    }

 function pickOptions(correct){
  // Determine roster by difficulty for decoy sourcing
  const roster =
    (state.difficulty === 'beginner') ? beginnerSpecies :
    (state.difficulty === 'novice')   ? noviceSpecies   :
                                        speciesList;    // full list for decoys

  const all = roster.filter(s => s !== correct);

  // BEGINNER: restrict whole round to beginner roster
  if (state.difficulty === 'beginner'){
    const pool = beginnerSpecies.filter(s => s !== correct);
    shuffle(pool);
    return [correct, ...pool.slice(0,3)].sort(()=> Math.random() - .5);
  }

  // NOVICE: simple random decoys from novice roster (no category rule)
  if (state.difficulty === 'novice'){
    const pool = noviceSpecies.filter(s => s !== correct);
    shuffle(pool);
    return [correct, ...pool.slice(0,3)].sort(()=> Math.random() - .5);
  }

  // INTERMEDIATE & EXPERT
  const sameCat = all.filter(s => s.category === correct.category && s.scientific !== correct.scientific);
  const otherCats = all.filter(s => s.category !== correct.category);
  shuffle(sameCat); shuffle(otherCats);

  if (state.difficulty === 'intermediate'){
    // 2 from same category, 1 from another category
    const picks = [...sameCat.slice(0,2), ...otherCats.slice(0,1)];
    // Safety fill
    while (picks.length < 3){
      const extra = all.find(s => !picks.includes(s));
      if (!extra) break;
      picks.push(extra);
    }
    return [correct, ...picks.slice(0,3)].sort(()=> Math.random() - .5);
  } else {
    // EXPERT: all 3 decoys from the same category
    const picks = sameCat.slice(0,3);
    // Safety fill
    if (picks.length < 3){
      const extras = all.filter(s => !picks.includes(s));
      shuffle(extras);
      picks.push(...extras.slice(0, 3 - picks.length));
    }
    return [correct, ...picks.slice(0,3)].sort(()=> Math.random() - .5);
  }
}

    async function renderNewQuestion() {
        updateHud();
        // Clear previous content before fetching new data
        imageGrid.innerHTML = '';
        answersEl.innerHTML = '';

        // Determine question type
        if (state.difficulty === 'expert') {
            if (state.questionTypeQueue.length > 0) {
                state.questionType = state.questionTypeQueue.pop();
            } else {
                console.error("Expert question queue depleted unexpectedly.");
                state.questionType = 'classic'; // Fallback
            }
        } else {
            state.questionType = 'classic';
        }

        // Reset UI elements to a clean state
        $('#questionText').style.display = 'none';
        imageGrid.style.display = 'grid';
        answersEl.className = 'answers';

        // Fetch and render based on type
        if (state.questionType === 'photoChoice') {
            const data = await fetchPhotoChoiceData();
            renderPhotoChoiceQuestion(data);
        } else {
            const pool = (state.difficulty === 'beginner') ? beginnerSpecies :
                         (state.difficulty === 'novice') ? noviceSpecies :
                         advancedSpecies;
            const remaining = pool.filter(s => !state.seen.has(s.scientific));
            const base = remaining.length ? remaining : pool;
            const correct = base[Math.floor(Math.random() * base.length)];

            const obs = await fetchOneObservation(correct.scientific);
            if (!obs) {
                console.error("Failed to fetch observation, trying again.");
                return renderNewQuestion(); // Retry if fetch fails
            }

            state.current = { correct, obsId: obs.id, uris: [obs.uri] };
            state.seen.add(correct.scientific);
            state.newPhotosUsed = false;

            if (state.questionType === 'textInput') {
                renderTextInputQuestion({ correct, obs });
            } else {
                newBtn.style.display = 'inline-flex';
                refreshNewPhotosBtn();
                renderPhotos(obs, correct);
                const options = pickOptions(correct);
                state.current.options = options; // Store options for later
                renderAnswers(options);
            }
        }
    }

    /* Start game */
    $('#startBtn').addEventListener('click', async () => {
        state.isGameActive = true;
        state.score = 0; state.q = 0; state.seen.clear();
        state.review = [];
        state.newPhotosLeft = computeNewPhotoQuota(state.total, state.difficulty);
        qEl.textContent = `0 / ${state.total}`;

        state.questionTypeQueue = [];
        if (state.difficulty === 'expert') {
            const numSets = state.total / 10;
            const classicCount = 3 * numSets;
            const photoChoiceCount = 3 * numSets;
            const textInputCount = 4 * numSets;
            const queue = [
                ...Array(classicCount).fill('classic'),
                ...Array(photoChoiceCount).fill('photoChoice'),
                ...Array(textInputCount).fill('textInput')
            ];
            state.questionTypeQueue = shuffle(queue);
        }

        setScreen('loading');
        try {
            await renderNewQuestion();
            setScreen('game');
            const gameContent = $('#gameContent');
            // Use rAF to ensure the animation plays on the first question
            requestAnimationFrame(() => {
              gameContent.classList.add('is-entering');
              requestAnimationFrame(() => {
                gameContent.classList.add('visible');
                gameContent.addEventListener('animationend', () => {
                    gameContent.classList.remove('is-entering', 'visible');
                }, { once: true });
              });
            });
        } catch (e) {
            $('#errorMsg').textContent = 'Could not load the first mushroom question. Please try again.';
            $('#errorModal').classList.add('active');
        }
    });

    $('#retryBtn').addEventListener('click', ()=>{
      $('#errorModal').classList.remove('active');
      setScreen('start');
    });

    newBtn.addEventListener('click', async ()=>{
      if (state.newPhotosUsed || state.newPhotosLeft <= 0) return;

      newBtn.disabled = true;
      const obs = await fetchOneObservation(state.current.correct.scientific, state.current.obsId);

      if (obs){
        renderPhotos(obs, state.current.correct);
        state.current.obsId = obs.id;
        if (!state.current.uris.includes(obs.uri)) state.current.uris.push(obs.uri);
        state.newPhotosUsed = true;
        state.newPhotosLeft--;
                pushRecent(state.current.correct.scientific, obs.id);
        rememberUsed(state.current.correct.scientific, obs.id);
        }

      refreshNewPhotosBtn();
    });

    answersEl.addEventListener('click', e=>{
      const btn = e.target.closest('.answer'); if (!btn) return;

      let wasCorrect = false;
      let chose = '';
      let uris = [...(state.current.uris || [])];
      let timeout = 450;

      if (state.questionType === 'classic') {
        const buttons = [...answersEl.querySelectorAll('.answer')];
        buttons.forEach(b=>b.disabled = true);
        const chosenId = Number(btn.dataset.id);
        wasCorrect = chosenId === state.current.correct.id;
        const chosenObject = state.current.options.find(opt => opt.id === chosenId);
        chose = chosenObject || { name: 'Unknown', scientific: 'Unknown' };

        if (wasCorrect) {
          btn.classList.add('correct');
        } else {
          btn.classList.add('incorrect');
          const correctBtn = buttons.find(b => Number(b.dataset.id) === state.current.correct.id);
          if (correctBtn) correctBtn.classList.add('correct');
        }
        pushRecent(state.current.correct.scientific, state.current.obsId);
        rememberUsed(state.current.correct.scientific, state.current.obsId);

      } else if (state.questionType === 'photoChoice') {
        const buttons = [...answersEl.querySelectorAll('.answer')];
        buttons.forEach(b=>b.disabled = true);
        const chosenIndex = Number(btn.dataset.index);
        wasCorrect = chosenIndex === state.current.correctIndex;
        chose = state.current.options[chosenIndex]; // Store the full species object
        uris = state.current.uris;

        if (wasCorrect){
          btn.classList.add('correct');
        } else {
          btn.classList.add('incorrect');
          buttons[state.current.correctIndex].classList.add('correct');
        }
      } else if (state.questionType === 'textInput') {
        if (btn.id !== 'textAnswerSubmit') return;

        const inputEl = $('#textAnswerInput');
        const userInput = inputEl.value.trim();
        if (!userInput) return;

        chose = userInput;
        const userInputLower = userInput.toLowerCase();
        const correctCommon = state.current.correct.name.toLowerCase();
        const correctScientific = state.current.correct.scientific.toLowerCase();

        const distScientific = levenshtein(userInputLower, correctScientific);
        const thresholdScientific = Math.max(1, Math.floor(correctScientific.length / 4));

        if (state.scientificMode) {
          wasCorrect = distScientific <= thresholdScientific;
        } else {
          const distCommon = levenshtein(userInputLower, correctCommon);
          const thresholdCommon = Math.max(1, Math.floor(correctCommon.length / 4));
          wasCorrect = (distCommon <= thresholdCommon) || (distScientific <= thresholdScientific);
        }

        const correctAnswer = state.scientificMode
          ? state.current.correct.scientific
          : `${state.current.correct.name} (${state.current.correct.scientific})`;

        inputEl.readOnly = true;
        btn.disabled = true;
        inputEl.value = correctAnswer;
        inputEl.classList.add(wasCorrect ? 'correct' : 'incorrect');
        pushRecent(state.current.correct.scientific, state.current.obsId);
        rememberUsed(state.current.correct.scientific, state.current.obsId);
        timeout = 1000;
      }

      if (wasCorrect) {
        state.score += state.scientificMode ? 20 : 10;
      }

      state.review.push({
        n: state.q + 1,
        name: state.current.correct.name,
        scientific: state.current.correct.scientific,
        chose: chose,
        correct: wasCorrect,
        uris: uris
      });

      state.q++;
      const isLast = state.q >= state.total;

      if (isLast){
        setTimeout(()=>{
          const pointsPerQ = state.scientificMode ? 20 : 10;
          $('#finalScore').textContent = state.score;
          $('#finalScoreTotal').textContent = String(state.total * pointsPerQ);

          const diffPill = $('#resultsDifficulty');
          let pillText = state.difficulty;
          if (state.scientificMode) {
            diffPill.classList.add('scientific');
            pillText += ' &middot; Scientific Mode';
          } else {
            diffPill.classList.remove('scientific');
          }
          diffPill.innerHTML = pillText;

          setScreen('results');
          renderReview();
        }, timeout);
      } else {
        // Use timeout to allow correct/incorrect styles to be seen
        setTimeout(() => {
          const gameContent = $('#gameContent');
          gameContent.classList.add('is-exiting');

          gameContent.addEventListener('animationend', async function onExit() {
            gameContent.removeEventListener('animationend', onExit);

            // 1. Render the new content
            await renderNewQuestion();

            // 2. Animate the new content in
            gameContent.classList.remove('is-exiting');
            gameContent.classList.add('is-entering');

            // Use requestAnimationFrame to ensure the 'visible' class is applied after 'is-entering'
            requestAnimationFrame(() => {
              gameContent.classList.add('visible');
            });

            // 3. Clean up classes after the enter animation finishes
            gameContent.addEventListener('animationend', function onEnter() {
              gameContent.removeEventListener('animationend', onEnter);
              gameContent.classList.remove('is-entering', 'visible');
            }, { once: true });

          }, { once: true });
        }, timeout);
      }
    });


    // Keyboard shortcuts for Expert mode
    document.addEventListener('keydown', (e)=>{
      if (!state.isGameActive || state.difficulty !== 'expert') return;
      const key = e.key.toLowerCase();
      const active = document.activeElement;

      if (state.questionType === 'textInput' && key === 'enter') {
        const submit = $('#textAnswerSubmit');
        if (submit && !submit.disabled) { e.preventDefault(); submit.click(); }
      } else if (key === 'n' && active && active.id !== 'textAnswerInput') {
        if (newBtn.style.display !== 'none' && !newBtn.disabled) newBtn.click();
      } else if (state.questionType === 'photoChoice' && ['1','2','3','4'].includes(key) && active && active.id !== 'textAnswerInput') {
        const idx = Number(key) - 1;
        const btn = answersEl.querySelector(`.answer[data-index="${idx}"]`);
        if (btn && !btn.disabled) btn.click();
      }
    });

    // Scientific Mode toggle (Latin-only answers)
    const sciToggle = document.getElementById('scientificToggle');
    if (sciToggle){
      state.scientificMode = !!sciToggle.checked;
      sciToggle.addEventListener('change', (e)=>{ state.scientificMode = e.target.checked; });
    }


    /* Difficulty buttons */
    diffButtons.forEach(b=>{
      b.addEventListener('click', ()=>{
        diffButtons.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        state.difficulty = b.dataset.difficulty;
      });
    });

    /* QUIZ LENGTH (10/20/30) */
    lenButtons.forEach(b=>{
      b.addEventListener('click', ()=>{
        lenButtons.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        state.total = Number(b.dataset.questions) || 10;
        qEl.textContent = `0 / ${state.total}`;
      });
    });

    $('#playAgainBtn').addEventListener('click', ()=>{ setScreen('start'); });

    setScreen('start');
  </script>
</body>
</html>
