<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fungidentification</title>
  <style>
    /* --- Base --- */
    :root{
      --bg:#f5e6d3; --card:#fff8f0; --ink:#3d2914; --ink-2:#5d4e37; --muted:#8b7355;
      --brand-1:#8b6f47; --brand-2:#6b5637; --ring:rgba(139,90,43,.15);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:var(--bg); color:var(--ink); padding:20px; display:flex; justify-content:center;
    }
    .game{width:100%; max-width:960px; background:var(--card); border-radius:20px; padding:24px;
      border:1px solid rgba(139,90,43,.12); box-shadow:0 10px 30px rgba(139,90,43,.15)}
    .header{ text-align:center; margin-bottom:12px }
    h1{margin:0; font-size:2.2rem; color:var(--ink-2)}
    .sub{color:var(--muted)}

    /* --- HUD (Score / Question) --- */
    .hud{ display:none; /* hidden on landing */ 
      justify-content:center; gap:16px; flex-wrap:wrap; margin:16px 0 12px}
    .hud .box{min-width:150px; padding:12px 18px; text-align:center; border-radius:12px;
      background:rgba(139,90,43,.08); border:1px solid var(--ring)}
    .hud .label{color:var(--muted); font-size:.9rem}
    .hud .value{color:var(--ink-2); font-weight:800; font-size:1.6rem}

    /* --- Screens --- */
    .screen{display:none}
    .screen.active{display:block}

    /* --- Difficulty row --- */
    .difficulty{ display:flex; justify-content:center; gap:10px; flex-wrap:nowrap; margin:14px 0 18px }
    .diff-btn{
      background:#d4c8b8; color:var(--ink-2); border:1px solid #bcaea0; border-radius:999px;
      padding:10px 16px; min-width:110px; font-weight:700; cursor:pointer
    }
    .diff-btn.active{ background:var(--brand-1); color:#fff; border-color:transparent }

    /* Make the three buttons fit on narrow screens */
    @media (max-width:420px){
      .difficulty{ gap:8px }
      .diff-btn{ min-width:96px; padding:8px 12px; font-size:.95rem }
    }

    /* --- Image grid (always 2√ó2) --- */
    .image-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; max-width:740px; margin:0 auto 10px }
    .img-card{ border:2px solid var(--ring); border-radius:14px; overflow:hidden; background:#eee0cf; aspect-ratio:1/1 }
    .img-card img{ width:100%; height:100%; object-fit:cover; display:block }

    /* attribution under each image (compact) */
    .credit{ font-size:12px; color:var(--muted); background:#efe6da; padding:4px 6px; }

    /* --- Controls --- */
    .actions{ text-align:center; margin:10px 0 12px }
    #newPhotosBtn{
      display:inline-flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg, var(--brand-1), var(--brand-2)); color:#fff;
      border:none; padding:12px 24px; border-radius:999px; font-weight:800; cursor:pointer;
      box-shadow:0 8px 24px rgba(139,90,43,.25)
    }

    /* --- Answers grid --- */
    .answers{
      display:grid; gap:12px; max-width:740px; margin:0 auto;
      grid-template-columns:repeat(4, minmax(0,1fr));
    }
    @media (max-width:768px){
      .answers{ grid-template-columns:repeat(2, minmax(0,1fr)); }
    }
    .answer{
      background: rgba(255,248,240,.9); border:2px solid var(--ring); border-radius:12px;
      padding:14px; text-align:center; font-weight:700; cursor:pointer
    }
    .answer small{ display:block; color:var(--muted) }
    .answer.correct{ background:rgba(76,175,80,.18); border-color:#4CAF50; color:#2e7d32}
    .answer.incorrect{ background:rgba(244,67,54,.18); border-color:#F44336; color:#c62828}
    .answer:disabled{ opacity:.7; cursor:not-allowed }

    .footnote{ text-align:center; color:var(--muted); margin-top:10px }

    /* --- Modal --- */
    .modal{ position:fixed; inset:0; background:rgba(61,41,20,.85); display:none; place-items:center; z-index:1000 }
    .modal.active{ display:grid }
    .modal .card{ background:var(--card); padding:24px; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,.35); text-align:center }
    .btn{ background:linear-gradient(135deg, var(--brand-1), var(--brand-2)); color:#fff; border:none; padding:12px 22px; border-radius:999px; font-weight:800; cursor:pointer }

  </style>
</head>
<body>
  <div class="game">
    <div class="header">
      <h1>üçÑ Fungidentification</h1>
      <div class="sub">Test your mycology knowledge in nature's classroom</div>
    </div>

    <!-- HUD (hidden on landing; shown only during game) -->
    <div id="hud" class="hud">
      <div class="box">
        <div class="label">Score</div>
        <div id="score" class="value">0</div>
      </div>
      <div class="box">
        <div class="label">Question</div>
        <div id="questionCounter" class="value">0 / 30</div>
      </div>
    </div>

    <!-- Start / Landing -->
    <section id="start" class="screen active">
      <h2 style="text-align:center;margin:10px 0 6px;">Welcome to the Mushroom ID Challenge!</h2>
      <p style="text-align:center;margin:0 0 10px;">You will be shown 30 mushroom species to identify. Each round shows 4 photos of the same species.</p>

      <div class="difficulty" id="difficultyRow">
        <button class="diff-btn active" data-difficulty="beginner">Beginner</button>
        <button class="diff-btn" data-difficulty="intermediate">Intermediate</button>
        <button class="diff-btn" data-difficulty="expert">Expert</button>
      </div>

      <div style="text-align:center;">
        <button id="startBtn" class="btn">Start Game</button>
      </div>
    </section>

    <!-- Loading -->
    <section id="loading" class="screen">
      <h2 style="text-align:center;margin-bottom:10px;">Loading mushroom data‚Ä¶</h2>
      <div style="text-align:center;color:var(--muted)">Foraging for fungi on iNaturalist‚Ä¶</div>
    </section>

    <!-- Game -->
    <section id="game" class="screen">
      <div class="image-grid" id="imageGrid"></div>

      <div class="actions">
        <a id="inatLink" href="#" target="_blank" style="display:none; margin:0 0 10px; color:var(--ink-2); font-weight:800;">View on iNaturalist</a><br />
        <button id="newPhotosBtn" style="display:none">New Photos (1 use)</button>
      </div>

      <div id="answers" class="answers"></div>
    </section>

    <!-- Results -->
    <section id="results" class="screen">
      <h2 style="text-align:center;margin:10px 0;">Quiz complete!</h2>
      <div style="text-align:center">
        <p style="font-size:1.25rem;">Final Score: <span id="finalScore">0</span> / 300</p>
        <p>Correct Answers: <span id="correctAnswers">0</span> / <span id="totalQuestions">30</span></p>
        <p>Best Streak: <span id="bestStreak">0</span></p>
        <button id="playAgainBtn" class="btn">Play again</button>
      </div>
    </section>

    <div class="footnote">Images sourced from iNaturalist API under Creative Commons licenses</div>
  </div>

  <!-- Error modal -->
  <div id="errorModal" class="modal">
    <div class="card">
      <h3>Oops! Something went wrong</h3>
      <p id="errorMsg" style="color:#c9302c; margin:10px 0 16px;">Could not load the first mushroom question.</p>
      <button id="retryBtn" class="btn">Try again</button>
    </div>
  </div>

  <script>
    /* ---------------- state & DOM ---------------- */
    const $ = sel => document.querySelector(sel);
    const hud = $('#hud');
    const screens = { start: $('#start'), loading: $('#loading'), game: $('#game'), results: $('#results') };
    const scoreEl = $('#score'), qEl = $('#questionCounter');
    const imageGrid = $('#imageGrid'), answersEl = $('#answers');
    const newBtn = $('#newPhotosBtn'), inatLink = $('#inatLink');

    const diffButtons = [...document.querySelectorAll('.diff-btn')];

    const state = {
      difficulty: 'beginner',
      score: 0, q: 0, total: 30,
      isGameActive: false,
      seen: new Set(),
      newPhotosUsed: false,
      current: null,
    };

    /* ---------------- species list (names only; ids resolved at runtime) ---------------- */
    const speciesList = [
      { name:"Fly Agaric", scientific:"Amanita muscaria", category:"Amanita" },
      { name:"Death Cap", scientific:"Amanita phalloides", category:"Amanita" },
      { name:"The Blusher", scientific:"Amanita rubescens", category:"Amanita" },
      { name:"Panther Cap", scientific:"Amanita pantherina", category:"Amanita" },
      { name:"False Death Cap", scientific:"Amanita citrina", category:"Amanita" },
      { name:"Destroying Angel", scientific:"Amanita virosa", category:"Amanita" },
      { name:"Orange Grisette", scientific:"Amanita crocea", category:"Amanita" },
      /* (‚Ä¶keep your full list here exactly as before, minus the id fields‚Ä¶) */
    ];

    /* ---------------- utility ---------------- */
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    const ALLOWED = new Set(['cc0','cc-by','cc-by-sa','cc-by-nd','cc-by-nc','cc-by-nc-sa','cc-by-nc-nd']);

    function setScreen(name){
      Object.values(screens).forEach(s=>s.classList.remove('active'));
      screens[name].classList.add('active');
      // show HUD only in game screen
      hud.style.display = (name === 'game') ? 'flex' : 'none';
    }
    function updateHud(){
      scoreEl.textContent = state.score;
      qEl.textContent = `${state.q+1} / ${state.total}`;
    }

    /* ----------- resolve iNat taxon id from scientific name (cached) ----------- */
    async function resolveTaxonId(scientific){
      const key = `inatTaxonId:${scientific}`;
      const cached = localStorage.getItem(key);
      if (cached) return Number(cached);
      const url = `https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(scientific)}&rank=species&is_active=true&per_page=1`;
      const r = await fetch(url); const j = await r.json();
      const id = j?.results?.[0]?.id;
      if (!id) throw new Error(`Could not resolve taxon for ${scientific}`);
      localStorage.setItem(key, String(id));
      return id;
    }

    /* ----------- image helpers (avoid blurry thumbs) ----------- */
    function bestPhotoUrls(p){
      const med = p.medium_url || (p.url ? p.url.replace('/square.', '/medium.') : null);
      const lg  = p.large_url  || (p.url ? p.url.replace('/square.', '/large.')  : med);
      return { med, lg };
    }

    /* ----------- fetch one observation with CC-licensed photos ----------- */
    async function fetchOneObservation(scientific, excludeId=null){
      const taxonId = await resolveTaxonId(scientific);
      for (let page=1; page<=5; page++){
        const params = new URLSearchParams({
          taxon_id: String(taxonId),
          has: 'photos',
          quality_grade: 'needs_id,research',
          per_page: '50',
          order: 'desc',
          order_by: 'observed_on',
          page: String(page),
          fields: 'results.id,results.uri,results.taxon.id,' +
                  'results.photos.id,results.photos.url,results.photos.medium_url,results.photos.large_url,' +
                  'results.photos.attribution,results.photos.license_code'
        });
        if (excludeId) params.set('not_id', String(excludeId));
        const url = `https://api.inaturalist.org/v1/observations?${params.toString()}`;
        const r = await fetch(url);
        if (!r.ok){ continue; }
        const data = await r.json();
        const pool = (data.results||[]).filter(o => o.photos?.some(p => ALLOWED.has((p.license_code||'').toLowerCase())));
        if (pool.length){
          // pick one with at least 3 good photos
          const pick = pool.find(o => o.photos.filter(p => ALLOWED.has((p.license_code||'').toLowerCase())).length >= 3) || pool[0];
          return pick;
        }
      }
      return null;
    }

    /* ----------- render question ----------- */
    function renderPhotos(observation, species){
      imageGrid.innerHTML = '';
      const good = observation.photos.filter(p => ALLOWED.has((p.license_code||'').toLowerCase())).slice(0,3);
      const four = [...good];
      while (four.length < 4 && good.length) four.push(good[0]); // duplicate to 4

      four.forEach(p=>{
        const { med, lg } = bestPhotoUrls(p);
        const wrap = document.createElement('div'); wrap.className = 'img-card';
        wrap.innerHTML = `
          <img loading="lazy" decoding="async" src="${med}" srcset="${med} 1x, ${lg} 2x" alt="${species.name}">
          <div class="credit">(c) ${p.attribution || 'iNaturalist user'} &nbsp; ${String(p.license_code||'').toUpperCase()}</div>`;
        imageGrid.appendChild(wrap);
      });

      inatLink.style.display = 'inline-block';
      inatLink.href = observation.uri;
    }

    function renderAnswers(options, correct){
      answersEl.innerHTML = options.map((sp, i)=>`
        <button class="answer" data-i="${i}">
          ${sp.name}<small><em>${sp.scientific}</em></small>
        </button>`).join('');
    }

    /* ----------- round flow ----------- */
    async function nextQuestion(initial=false){
      updateHud();
      const candidates = speciesList.filter(s => !state.seen.has(s.scientific));
      const correct = candidates[Math.floor(Math.random()*candidates.length)] || speciesList[Math.floor(Math.random()*speciesList.length)];
      const obs = await fetchOneObservation(correct.scientific);
      if (!obs){ if (initial) throw new Error('No observation to start'); return nextQuestion(initial); }

      state.current = { correct, obsId: obs.id };
      state.seen.add(correct.scientific);
      state.newPhotosUsed = false;
      newBtn.style.display = 'inline-flex'; newBtn.disabled = false; newBtn.textContent = 'New Photos (1 use)';

      renderPhotos(obs, correct);

      // build 3 distractors
      const pool = speciesList.filter(s => s !== correct);
      const picks = [];
      const byCat = pool.filter(s => s.category === correct.category);
      while (picks.length<2 && byCat.length) picks.push(byCat.splice(Math.floor(Math.random()*byCat.length),1)[0]);
      while (picks.length<3 && pool.length) picks.push(pool.splice(Math.floor(Math.random()*pool.length),1)[0]);

      const options = [correct, ...picks].sort(()=>Math.random()-.5);
      renderAnswers(options, correct);
    }

    /* ----------- events ----------- */
    $('#startBtn').addEventListener('click', async ()=>{
      state.isGameActive = true;
      state.score = 0; state.q = 0; state.seen.clear();
      setScreen('loading');
      try{
        await nextQuestion(true);
        setScreen('game');
      }catch(e){
        $('#errorMsg').textContent = 'Could not load the first mushroom question. Please try again.';
        $('#errorModal').classList.add('active');
      }
    });

    $('#retryBtn').addEventListener('click', ()=>{
      $('#errorModal').classList.remove('active');
      setScreen('start');
    });

    newBtn.addEventListener('click', async ()=>{
      if (state.newPhotosUsed) return;
      state.newPhotosUsed = true; newBtn.disabled = true; newBtn.textContent = 'Loading‚Ä¶';
      const obs = await fetchOneObservation(state.current.correct.scientific, state.current.obsId);
      if (obs){ renderPhotos(obs, state.current.correct); newBtn.textContent = 'New Photos Used'; }
      else { newBtn.textContent = 'No Alternatives Found'; }
    });

    answersEl.addEventListener('click', e=>{
      const btn = e.target.closest('.answer'); if (!btn) return;
      const idx = Number(btn.dataset.i);
      const buttons = [...answersEl.querySelectorAll('.answer')];
      buttons.forEach(b=>b.disabled = true);

      const chosen = buttons[idx].textContent.trim();
      const correctName = state.current.correct.name;

      if (chosen.startsWith(correctName)){
        btn.classList.add('correct'); state.score += 10;
      } else {
        btn.classList.add('incorrect');
        const i = buttons.findIndex(b => b.textContent.trim().startsWith(correctName));
        if (i>-1) buttons[i].classList.add('correct');
      }
      state.q++;
      if (state.q >= state.total){
        $('#finalScore').textContent = state.score;
        $('#correctAnswers').textContent = Math.floor(state.score/10);
        $('#totalQuestions').textContent = state.total;
        $('#bestStreak').textContent = '‚Äî';
        setScreen('results'); state.isGameActive = false;
      } else {
        setTimeout(()=> nextQuestion(false), 600);
      }
      updateHud();
    });

    diffButtons.forEach(b=>{
      b.addEventListener('click', ()=>{
        diffButtons.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        state.difficulty = b.dataset.difficulty;
      });
    });

    $('#playAgainBtn').addEventListener('click', ()=>{ setScreen('start'); });

    // Landing
    setScreen('start');
  </script>
</body>
</html>
