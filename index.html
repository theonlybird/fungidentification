<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fungidentification</title>
  <style>
    :root{
      --bg:#f5e6d3; --card:#fff8f0; --ink:#3d2914; --ink-2:#5d4e37; --muted:#8b7355;
      --brand-1:#8b6f47; --brand-2:#6b5637; --ring:rgba(139,90,43,.15);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:var(--bg); color:var(--ink); padding:20px; display:flex; justify-content:center;
    }
    .game{width:100%; max-width:1000px; background:var(--card); border-radius:20px; padding:24px;
      border:1px solid rgba(139,90,43,.12); box-shadow:0 10px 30px rgba(139,90,43,.15)}
    .header{ text-align:center; margin-bottom:8px }
    h1{margin:0; font-size:2.25rem; color:var(--ink-2); font-weight:700}
    .sub{color:var(--muted)}

    /* HUD (hidden on landing; side-by-side on mobile) */
    .hud{ display:none; justify-content:center; gap:16px; flex-wrap:wrap; margin:14px 0 10px}
    .hud .box{min-width:150px; padding:10px 16px; text-align:center; border-radius:12px;
      background:rgba(139,90,43,.08); border:1px solid var(--ring)}
    .hud .label{color:var(--muted); font-size:.9rem}
    .hud .value{color:var(--ink-2); font-weight:600; font-size:1.45rem}

    /* Screens */
    .screen{display:none}
    .screen.active{display:block}

    /* Difficulty row (3 inline, centered) */
    .difficulty{ display:flex; justify-content:center; gap:10px; flex-wrap:nowrap; margin:12px 0 18px }
    .diff-btn{
      background:#d4c8b8; color:var(--ink-2); border:1px solid #bcaea0; border-radius:999px;
      padding:10px 16px; min-width:110px; font-weight:700; cursor:pointer
    }
    .diff-btn.active{ background:var(--brand-1); color:#fff; border-color:transparent }
    @media (max-width:420px){
      .difficulty{ gap:8px }
      .diff-btn{ min-width:96px; padding:8px 12px; font-size:.95rem }
    }

    /* Image grid (2√ó2 always) */
    .image-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; max-width:740px; margin:0 auto 10px }
    .img-card{ border:2px solid var(--ring); border-radius:14px; overflow:hidden; background:transparent; }
    .img-wrap{ position:relative; aspect-ratio:1/1; background:#eee0cf; }
    .img-wrap img{ width:100%; height:100%; object-fit:cover; display:block }

    /* License caption: translucent overlay ON the photo */
    .credit{
      position:absolute;
      left:6px; right:6px; bottom:6px;
      z-index:2;
      padding:4px 8px;
      font-size: clamp(8px, 1.6vw, 12px);
      line-height:1.25;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;

      display:flex; gap:8px; align-items:center; justify-content:center;

      color:var(--muted);
      background: linear-gradient(to bottom, rgba(255,255,255,.78), rgba(255,255,255,.62));
      -webkit-backdrop-filter: blur(4px) saturate(120%);
      backdrop-filter: blur(4px) saturate(120%);
      border:1px solid rgba(0,0,0,.12);
      border-radius:10px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
      pointer-events:none; /* overlay won't block taps/clicks */
    }
    .credit .name{white-space:nowrap}
    .license-badge{
      font-size: 0.92em; font-weight:700; letter-spacing:.2px; color:#4b3a23;
      white-space:nowrap;
      border:1px solid rgba(0,0,0,.18);
      border-radius:6px;
      padding:1px 6px;
      background: rgba(231,219,205,.55);
      flex:0 0 auto;
    }

    /* Controls */
    .actions{ text-align:center; margin:10px 0 12px }
    #inatLink{ display:none; margin:0 0 10px; color:var(--ink-2); font-weight:700; text-decoration:underline }
    #newPhotosBtn{
      display:inline-flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg, var(--brand-1), var(--brand-2)); color:#fff;
      border:none; padding:12px 24px; border-radius:999px; font-weight:700; cursor:pointer;
      box-shadow:0 8px 24px rgba(139,90,43,.25)
    }

    /* Answers grid: 4-up desktop, 2√ó2 mobile; softer brown text */
    .answers{ display:grid; gap:12px; max-width:740px; margin:0 auto; grid-template-columns:repeat(4, minmax(0,1fr)); }
    @media (max-width:768px){ .answers{ grid-template-columns:repeat(2, minmax(0,1fr)); } }
    .answer{
      background: rgba(255,248,240,.9); border:2px solid var(--ring); border-radius:12px;
      padding:14px; text-align:center; font-weight:600; cursor:pointer;
      color:var(--ink-2);
      transition: background-color .15s ease, border-color .15s ease, transform .06s ease, box-shadow .15s ease;
    }
    @media (hover: hover) and (pointer: fine){
    .answer:hover:not(:disabled):not(.correct):not(.incorrect){
      background: rgba(139,90,43,.16);
      border-color: rgba(139,90,43,.38);
      box-shadow: 0 4px 12px rgba(139,90,43,.18);
      transform: translateY(-1px);
  }
  .answer:active:not(:disabled):not(.correct):not(.incorrect){
    transform: translateY(0);
    background: rgba(139,90,43,.22);
  }
  .answer:focus-visible{
    outline: 3px solid rgba(139,90,43,.45);
    outline-offset: 2px;
  }
}
    .answer small{ display:block; color:var(--muted); font-weight:400 }
    .answer.correct{ background:rgba(76,175,80,.18); border-color:#4CAF50; color:#2e7d32}
    .answer.incorrect{ background:rgba(244,67,54,.18); border-color:#F44336; color:#c62828}
    .answer:disabled{ opacity:.75; cursor:not-allowed }

    .footnote{ text-align:center; color:var(--muted); margin-top:10px }

    /* Modal */
    .modal{ position:fixed; inset:0; background:rgba(61,41,20,.85); display:none; place-items:center; z-index:1000 }
    .modal.active{ display:grid }
    .modal .card{ background:var(--card); padding:24px; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,.35); text-align:center }
    .btn{ background:linear-gradient(135deg, var(--brand-1), var(--brand-2)); color:#fff; border:none; padding:12px 22px; border-radius:999px; font-weight:700; cursor:pointer }

    @media (max-width: 420px) {
    .credit{ font-size: clamp(6px, 2.8vw, 9px); padding: 3px 6px; }
    .license-badge{ font-size: 0.9em; padding: 0 5px; letter-spacing: 0; }
    }

    /* Landing screen spacing tweaks */
    .header{ margin-bottom: 28px; }
    #start h2{ margin: 24px 0 12px !important; }
    #start p{ margin: 0 0 22px !important; }
    .difficulty{ margin: 14px 0 24px; }
  </style>
</head>
<body>
  <div class="game">
    <div class="header">
      <h1>üçÑ Fungidentification</h1>
      <div class="sub">Test your mycology knowledge in nature's classroom</div>
    </div>

    <!-- HUD (hidden until game) -->
    <div id="hud" class="hud">
      <div class="box">
        <div class="label">Score</div>
        <div id="score" class="value">0</div>
      </div>
      <div class="box">
        <div class="label">Question</div>
        <div id="questionCounter" class="value">0 / 30</div>
      </div>
    </div>

    <!-- Start -->
    <section id="start" class="screen active">
      <h2 style="text-align:center;margin:10px 0 6px;">Welcome to the Mushroom ID Challenge!</h2>
      <p style="text-align:center;margin:0 0 10px;">You will be shown 30 mushroom species to identify. Each round shows 4 photos of the same species.</p>

      <div class="difficulty" id="difficultyRow">
        <button class="diff-btn active" data-difficulty="beginner">Beginner</button>
        <button class="diff-btn" data-difficulty="intermediate">Intermediate</button>
        <button class="diff-btn" data-difficulty="expert">Expert</button>
      </div>

      <div style="text-align:center;">
        <button id="startBtn" class="btn">Start Game</button>
      </div>
    </section>

    <!-- Loading -->
    <section id="loading" class="screen">
      <h2 style="text-align:center;margin-bottom:10px;">Loading mushroom data‚Ä¶</h2>
      <div style="text-align:center;color:var(--muted)">Foraging for fungi on iNaturalist‚Ä¶</div>
    </section>

    <!-- Game -->
    <section id="game" class="screen">
      <div class="image-grid" id="imageGrid"></div>

      <div class="actions">
        <a id="inatLink" href="#" target="_blank" rel="noopener">View on iNaturalist</a><br />
        <button id="newPhotosBtn" style="display:none">New Photos (1 use)</button>
      </div>

      <div id="answers" class="answers"></div>
    </section>

    <!-- Results -->
    <section id="results" class="screen">
      <h2 style="text-align:center;margin:10px 0;">Quiz complete!</h2>
      <div style="text-align:center">
        <p style="font-size:1.25rem;">Final Score: <span id="finalScore">0</span> / 300</p>
        <p>Correct Answers: <span id="correctAnswers">0</span> / <span id="totalQuestions">30</span></p>
        <p>Best Streak: <span id="bestStreak">0</span></p>
        <button id="playAgainBtn" class="btn">Play again</button>
      </div>
    </section>

    <div class="footnote">Images sourced from iNaturalist API under Creative Commons licenses</div>
  </div>

  <!-- Error modal -->
  <div id="errorModal" class="modal">
    <div class="card">
      <h3>Oops! Something went wrong</h3>
      <p id="errorMsg" style="color:#c9302c; margin:10px 0 16px;">Could not load the first mushroom question.</p>
      <button id="retryBtn" class="btn">Try again</button>
    </div>
  </div>

  <script>
    /* ---------------- DOM & state ---------------- */
    const $ = sel => document.querySelector(sel);
    const hud = $('#hud');
    const screens = { start: $('#start'), loading: $('#loading'), game: $('#game'), results: $('#results') };
    const scoreEl = $('#score'), qEl = $('#questionCounter');
    const imageGrid = $('#imageGrid'), answersEl = $('#answers');
    const newBtn = $('#newPhotosBtn'), inatLink = $('#inatLink');
    const diffButtons = [...document.querySelectorAll('.diff-btn')];

    const state = {
      difficulty: 'beginner',
      score: 0, q: 0, total: 30,
      isGameActive: false,
      seen: new Set(),
      newPhotosUsed: false,
      current: null,
    };

    /* ------------- species (names only; ids resolved at runtime) ------------- */
    const speciesList = [
      { name: "Fly Agaric", scientific: "Amanita muscaria", category: "Amanita" },
      { name: "Death Cap", scientific: "Amanita phalloides", category: "Amanita" },
      { name: "The Blusher", scientific: "Amanita rubescens", category: "Amanita" },
      { name: "Panther Cap", scientific: "Amanita pantherina", category: "Amanita" },
      { name: "False Death Cap", scientific: "Amanita citrina", category: "Amanita" },
      { name: "Destroying Angel", scientific: "Amanita virosa", category: "Amanita" },
      { name: "Orange Grisette", scientific: "Amanita crocea", category: "Amanita" },
      { name: "Field Mushroom", scientific: "Agaricus campestris", category: "Agaricus" },
      { name: "Yellow Stainer", scientific: "Agaricus xanthodermus", category: "Agaricus" },
      { name: "Horse Mushroom", scientific: "Agaricus arvensis", category: "Agaricus" },
      { name: "Pavement Mushroom", scientific: "Agaricus bitorquis", category: "Agaricus" },
      { name: "Scaly Wood Mushroom", scientific: "Agaricus sylvaticus", category: "Agaricus" },
      { name: "The Prince", scientific: "Agaricus augustus", category: "Agaricus" },
      { name: "Oyster Mushroom", scientific: "Pleurotus ostreatus", category: "Pleurotus" },
      { name: "Pale Oyster", scientific: "Pleurotus pulmonarius", category: "Pleurotus" },
      { name: "Veiled Oyster", scientific: "Pleurotus dryinus", category: "Pleurotus" },
      { name: "Golden Oyster", scientific: "Pleurotus citrinopileatus", category: "Pleurotus" },
      { name: "Olive Oysterling", scientific: "Sarcomyxa serotina", category: "Pleurotus" },
      { name: "Scarlet Waxcap", scientific: "Hygrocybe coccinea", category: "Waxcaps" },
      { name: "Crimson Waxcap", scientific: "Hygrocybe punicea", category: "Waxcaps" },
      { name: "Blackening Waxcap", scientific: "Hygrocybe conica", category: "Waxcaps" },
      { name: "Parrot Waxcap", scientific: "Gliophorus psittacinus", category: "Waxcaps" },
      { name: "Meadow Waxcap", scientific: "Cuphophyllus pratensis", category: "Waxcaps" },
      { name: "Heath Waxcap", scientific: "Gliophorus laetus", category: "Waxcaps" },
      { name: "King Bolete", scientific: "Boletus edulis", category: "Boletes" },
      { name: "Bay Bolete", scientific: "Imleria badia", category: "Boletes" },
      { name: "Slippery Jack", scientific: "Suillus luteus", category: "Boletes" },
      { name: "Birch Bolete", scientific: "Leccinum scabrum", category: "Boletes" },
      { name: "Red Cracking Bolete", scientific: "Xerocomellus chrysenteron", category: "Boletes" },
      { name: "Suede Bolete", scientific: "Xerocomus subtomentosus", category: "Boletes" },
      { name: "Bleeding Bonnet", scientific: "Mycena haematopus", category: "Mycena" },
      { name: "Common Bonnet", scientific: "Mycena galericulata", category: "Mycena" },
      { name: "Clustered Bonnet", scientific: "Mycena inclinata", category: "Mycena" },
      { name: "Lilac Bonnet", scientific: "Mycena pura", category: "Mycena" },
      { name: "Saffrondrop Bonnet", scientific: "Mycena crocata", category: "Mycena" },
      { name: "Charcoal Burner", scientific: "Russula cyanoxantha", category: "Russula" },
      { name: "The Sickener", scientific: "Russula emetica", category: "Russula" },
      { name: "Beechwood Sickener", scientific: "Russula nobilis", category: "Russula" },
      { name: "Ochre Brittlegill", scientific: "Russula ochroleuca", category: "Russula" },
      { name: "Purple Brittlegill", scientific: "Russula atropurpurea", category: "Russula" },
      { name: "Greencracked Brittlegill", scientific: "Russula virescens", category: "Russula" },
      { name: "Powdery Brittlegill", scientific: "Russula parazurea", category: "Russula" },
      { name: "Stinking Brittlegill", scientific: "Russula foetens", category: "Russula" },
      { name: "Turkey Tail", scientific: "Trametes versicolor", category: "Brackets & Polypores" },
      { name: "Artist's Conk", scientific: "Ganoderma applanatum", category: "Brackets & Polypores" },
      { name: "Red-belted Polypore", scientific: "Fomitopsis pinicola", category: "Brackets & Polypores" },
      { name: "Birch Polypore", scientific: "Fomitopsis betulina", category: "Brackets & Polypores" },
      { name: "Lumpy Bracket", scientific: "Trametes gibbosa", category: "Brackets & Polypores" },
      { name: "Smoky Bracket", scientific: "Bjerkandera adusta", category: "Brackets & Polypores" },
      { name: "Hoof Fungus", scientific: "Fomes fomentarius", category: "Brackets & Polypores" },
      { name: "Beefsteak Fungus", scientific: "Fistulina hepatica", category: "Brackets & Polypores" },
      { name: "Purplepore Bracket", scientific: "Trichaptum abietinum", category: "Brackets & Polypores" },
      { name: "Crimped Gill", scientific: "Plicaturopsis crispa", category: "Brackets & Polypores" },
      { name: "Golden Chanterelle", scientific: "Cantharellus cibarius", category: "Chanterelles & Allies" },
      { name: "Horn of Plenty", scientific: "Craterellus cornucopioides", category: "Chanterelles & Allies" },
      { name: "Winter Chanterelle", scientific: "Craterellus tubaeformis", category: "Chanterelles & Allies" },
      { name: "False Chanterelle", scientific: "Hygrophoropsis aurantiaca", category: "Chanterelles & Allies" },
      { name: "Hedgehog Fungus", scientific: "Hydnum repandum", category: "Chanterelles & Allies" },
      { name: "Scaly Chanterelle", scientific: "Turbinellus floccosus", category: "Chanterelles & Allies" },
      { name: "Clouded Funnel", scientific: "Clitocybe nebularis", category: "Funnels & Grassland" },
      { name: "Trooping Funnel", scientific: "Infundibulicybe geotropa", category: "Funnels & Grassland" },
      { name: "Fairy Ring Champignon", scientific: "Marasmius oreades", category: "Funnels & Grassland" },
      { name: "St. George's Mushroom", scientific: "Calocybe gambosa", category: "Funnels & Grassland" },
      { name: "Brown Mottlegill", scientific: "Panaeolina foenisecii", category: "Funnels & Grassland" },
      { name: "Common Puffball", scientific: "Lycoperdon perlatum", category: "Funnels & Grassland" },
      { name: "Shaggy Mane", scientific: "Coprinus comatus", category: "Funnels & Grassland" },
      { name: "Common Inkcap", scientific: "Coprinopsis atramentaria", category: "Funnels & Grassland" },
      { name: "Magpie Inkcap", scientific: "Coprinopsis picacea", category: "Funnels & Grassland" },
      { name: "Shaggy Parasol", scientific: "Chlorophyllum rhacodes", category: "Funnels & Grassland" },
      { name: "The Parasol", scientific: "Macrolepiota procera", category: "Funnels & Grassland" },
      { name: "Liberty Cap", scientific: "Psilocybe semilanceata", category: "Funnels & Grassland" },
      { name: "Common Conecap", scientific: "Conocybe tenera", category: "Funnels & Grassland" },
      { name: "Orange Peel Fungus", scientific: "Aleuria aurantia", category: "Cup & other Saprotrophs" },
      { name: "King Alfred's Cakes", scientific: "Daldinia concentrica", category: "Cup & other Saprotrophs" },
      { name: "Scarlet Elfcup", scientific: "Sarcoscypha austriaca", category: "Cup & other Saprotrophs" },
      { name: "Yellow Stagshorn", scientific: "Calocera viscosa", category: "Cup & other Saprotrophs" },
      { name: "Jelly Ear", scientific: "Auricularia auricula-judae", category: "Cup & other Saprotrophs" },
      { name: "Yellow Brain", scientific: "Tremella mesenterica", category: "Cup & other Saprotrophs" },
      { name: "Funeral Bell", scientific: "Galerina marginata", category: "Woodland Fungi" },
      { name: "False Morel", scientific: "Gyromitra esculenta", category: "Woodland Fungi" },
      { name: "Honey Mushroom", scientific: "Armillaria mellea", category: "Woodland Fungi" },
      { name: "Sheathed Woodtuft", scientific: "Kuehneromyces mutabilis", category: "Woodland Fungi" },
      { name: "Common Rustgill", scientific: "Gymnopilus penetrans", category: "Woodland Fungi" },
      { name: "Velvet Shank", scientific: "Flammulina velutipes", category: "Woodland Fungi" },
      { name: "Wrinkled Peach", scientific: "Rhodotus palmatus", category: "Woodland Fungi" },
      { name: "Golden Scalycap", scientific: "Pholiota aurivella", category: "Woodland Fungi" },
      { name: "Lion's Mane", scientific: "Hericium erinaceus", category: "Distinctive Oddballs" },
      { name: "Chicken of the Woods", scientific: "Laetiporus sulphureus", category: "Distinctive Oddballs" },
      { name: "Hen of the Woods", scientific: "Grifola frondosa", category: "Distinctive Oddballs" },
      { name: "Giant Puffball", scientific: "Calvatia gigantea", category: "Distinctive Oddballs" },
      { name: "Devil's Fingers", scientific: "Clathrus archeri", category: "Distinctive Oddballs" },
      { name: "Dead Man's Fingers", scientific: "Xylaria polymorpha", category: "Distinctive Oddballs" },
      { name: "Wood Blewit", scientific: "Lepista nuda", category: "Blewits & Lookalikes" },
      { name: "Field Blewit", scientific: "Lepista saeva", category: "Blewits & Lookalikes" },
      { name: "Lilac Fibrecap", scientific: "Inocybe lilacina", category: "Blewits & Lookalikes" },
      { name: "Amethyst Deceiver", scientific: "Laccaria amethystina", category: "Blewits & Lookalikes" },
      { name: "Bruising Webcap", scientific: "Cortinarius purpurascens", category: "Blewits & Lookalikes" }
    ];

    /* ---------------- helpers ---------------- */
    const ALLOWED = new Set(['cc0','cc-by','cc-by-sa','cc-by-nd','cc-by-nc','cc-by-nc-sa','cc-by-nc-nd']);
    const recentObs = new Map(); // scientific -> Set of recent obs ids (avoid repeats in a session)
    function pushRecent(scientific, id, max=10){
      if (!recentObs.has(scientific)) recentObs.set(scientific, new Set());
      const s = recentObs.get(scientific); s.add(id);
      if (s.size > max){ const first = s.values().next().value; s.delete(first); }
    }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]] } return a; }
    function setScreen(name){
      Object.values(screens).forEach(s=>s.classList.remove('active'));
      screens[name].classList.add('active');
      hud.style.display = (name === 'game') ? 'flex' : 'none';
    }
    function updateHud(){ scoreEl.textContent = state.score; qEl.textContent = `${state.q+1} / ${state.total}`; }
    function formatLicense(code){ return code ? String(code).toUpperCase().replace(/_/g,'-') : 'ALL RIGHTS RESERVED'; }

    /** Keep only the photographer name from iNat attribution, drop leading (c)/¬© and trailing rights text */
    function cleanAttribution(str){
      let s = (str || '').trim();
      s = s.replace(/^(\(c\)|¬©)\s*/i,''); // drop leading copyright marker if present
      s = s.replace(/,\s*(?:some|all|no)\s+rights\s+reserved\s*\(.*?\)\s*$/i,''); // drop "some rights reserved (CC BY-..)"
      s = s.replace(/\s+/g,' ').trim();
      return s || 'iNaturalist user';
    }

    /* -------- resolve iNat taxon id from scientific name (cached) -------- */
    async function resolveTaxonId(scientific){
      const key = `inatTaxonId:${scientific}`;
      const cached = localStorage.getItem(key);
      if (cached) return Number(cached);
      const url = `https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(scientific)}&rank=species&is_active=true&per_page=1`;
      const r = await fetch(url); const j = await r.json();
      const id = j?.results?.[0]?.id;
      if (!id) throw new Error(`Could not resolve taxon for ${scientific}`);
      localStorage.setItem(key, String(id));
      return id;
    }

    /* -------- image helpers (avoid blurry thumbs) -------- */
    function bestPhotoUrls(p){
      const med = p.medium_url || (p.url ? p.url.replace('/square.', '/medium.') : null);
      const lg  = p.large_url  || (p.url ? p.url.replace('/square.', '/large.')  : med);
      return { med, lg };
    }

    /* -------- fetch one observation with CC-licensed photos (no repeats) -------- */
    async function fetchOneObservation(scientific, excludeId=null){
      const taxonId = await resolveTaxonId(scientific);

      // Probe for total_results to randomize pages
      const probeQS = new URLSearchParams({
        taxon_id: String(taxonId),
        has: 'photos',
        quality_grade: 'needs_id,research',
        per_page: '1',
        page: '1',
        fields: 'total_results'
      });
      if (excludeId) probeQS.set('not_id', String(excludeId));
      let r = await fetch(`https://api.inaturalist.org/v1/observations?${probeQS}`);
      if (!r.ok) return null;
      let j = await r.json();
      const total = j.total_results || 0;
      if (!total) return null;

      const perPage = 50;
      const pages = Math.max(1, Math.ceil(total / perPage));
      const tries = Math.min(6, pages);
      const triedPages = new Set();

      for (let t = 0; t < tries; t++){
        const page = t === 0 ? 1 : (() => {
          let p; do { p = 1 + Math.floor(Math.random() * pages); } while (triedPages.has(p) && triedPages.size < pages);
          return p;
        })();
        triedPages.add(page);

        const qs = new URLSearchParams({
          taxon_id: String(taxonId),
          has: 'photos',
          quality_grade: 'needs_id,research',
          per_page: String(perPage),
          page: String(page),
          order: 'desc',
          order_by: 'observed_on',
          fields:
            'results.id,results.uri,results.taxon.id,' +
            'results.photos.id,results.photos.url,results.photos.medium_url,results.photos.large_url,' +
            'results.photos.attribution,results.photos.license_code'
        });
        if (excludeId) qs.set('not_id', String(excludeId));

        r = await fetch(`https://api.inaturalist.org/v1/observations?${qs}`);
        if (!r.ok) continue;
        j = await r.json();

        // Filter to obs with at least ONE CC-licensed photo
        const pool = (j.results || []).filter(o =>
          Array.isArray(o.photos) && o.photos.some(p => ALLOWED.has(String(p.license_code||'').toLowerCase()))
        );
        if (!pool.length) continue;

        // Avoid recently used obs for this species
        const recent = recentObs.get(scientific) || new Set();
        const fresh = pool.filter(o => !recent.has(o.id));
        const candidates = fresh.length ? fresh : pool;

        shuffle(candidates);
        const pick =
          candidates.find(o => o.photos.filter(p => ALLOWED.has(String(p.license_code||'').toLowerCase())).length >= 2)
          || candidates[0];

        if (pick) return pick;
      }
      return null;
    }

    /* -------- render photos (overlay caption inside img-wrap) -------- */
    function renderPhotos(observation, species){
      imageGrid.innerHTML = '';
      const good = observation.photos.filter(p => ALLOWED.has(String(p.license_code||'').toLowerCase()));
      const pick = good.slice(0, 3);
      const four = pick.length === 3 ? [...pick, pick[0]] :
                   pick.length === 2 ? [...pick, ...pick] :
                   pick.length === 1 ? [pick[0], pick[0], pick[0], pick[0]] : [];

      four.forEach((p) => {
        const { med, lg } = bestPhotoUrls(p);
        const name = cleanAttribution(p.attribution);
        const card = document.createElement('div');
        card.className = 'img-card';
        card.innerHTML = `
          <div class="img-wrap">
            <img loading="lazy" decoding="async" src="${med}" srcset="${med} 1x, ${lg} 2x" alt="${species.name}">
            <div class="credit">
              <span class="name">(c) ${name}</span>
              <span class="license-badge">${formatLicense(p.license_code)}</span>
            </div>
          </div>
        `;
        imageGrid.appendChild(card);
      });

      inatLink.style.display = 'inline-block';
      inatLink.href = observation.uri;
    }

    function renderAnswers(options, correct){
      answersEl.innerHTML = options.map((sp, i)=>`
        <button class="answer" data-i="${i}">
          ${sp.name}<small><em>${sp.scientific}</em></small>
        </button>`).join('');
    }

    /* -------- round flow -------- */
    async function nextQuestion(initial=false){
      updateHud();

      // choose a species not yet used this game if possible
      const remaining = speciesList.filter(s => !state.seen.has(s.scientific));
      const correct = (remaining.length ? remaining : speciesList)[Math.floor(Math.random()*(remaining.length || speciesList.length))];

      const obs = await fetchOneObservation(correct.scientific);
      if (!obs){ if (initial) throw new Error('No observation to start'); return nextQuestion(initial); }

      state.current = { correct, obsId: obs.id };
      state.seen.add(correct.scientific);
      state.newPhotosUsed = false;
      newBtn.style.display = 'inline-flex'; newBtn.disabled = false; newBtn.textContent = 'New Photos (1 use)';

      renderPhotos(obs, correct);

      // build distractors (prefer same category)
      const pool = speciesList.filter(s => s !== correct);
      const picks = [];
      const byCat = pool.filter(s => s.category === correct.category);
      while (picks.length<2 && byCat.length) picks.push(byCat.splice((Math.random()*byCat.length)|0,1)[0]);
      while (picks.length<3 && pool.length) picks.push(pool.splice((Math.random()*pool.length)|0,1)[0]);

      const options = [correct, ...picks].sort(()=>Math.random()-.5);
      renderAnswers(options, correct);
    }

    /* -------- events -------- */
    $('#startBtn').addEventListener('click', async ()=>{
      state.isGameActive = true;
      state.score = 0; state.q = 0; state.seen.clear();
      setScreen('loading');
      try{
        await nextQuestion(true);
        setScreen('game');
      }catch(e){
        $('#errorMsg').textContent = 'Could not load the first mushroom question. Please try again.';
        $('#errorModal').classList.add('active');
      }
    });

    $('#retryBtn').addEventListener('click', ()=>{
      $('#errorModal').classList.remove('active');
      setScreen('start');
    });

    newBtn.addEventListener('click', async ()=>{
      if (state.newPhotosUsed) return;
      state.newPhotosUsed = true; newBtn.disabled = true; newBtn.textContent = 'Loading‚Ä¶';
      const obs = await fetchOneObservation(state.current.correct.scientific, state.current.obsId);
      if (obs){ renderPhotos(obs, state.current.correct); state.current.obsId = obs.id; newBtn.textContent = 'New Photos Used'; pushRecent(state.current.correct.scientific, obs.id); }
      else { newBtn.textContent = 'No Alternatives Found'; }
    });

    answersEl.addEventListener('click', e=>{
      const btn = e.target.closest('.answer'); if (!btn) return;
      const idx = Number(btn.dataset.i);
      const buttons = [...answersEl.querySelectorAll('.answer')];
      buttons.forEach(b=>b.disabled = true);

      const chosen = buttons[idx].textContent.trim();
      const correctName = state.current.correct.name;

      if (chosen.startsWith(correctName)){
        btn.classList.add('correct'); state.score += 10;
      } else {
        btn.classList.add('incorrect');
        const i = buttons.findIndex(b => b.textContent.trim().startsWith(correctName));
        if (i>-1) buttons[i].classList.add('correct');
      }
      pushRecent(state.current.correct.scientific, state.current.obsId);

      state.q++;
      if (state.q >= state.total){
        $('#finalScore').textContent = state.score;
        $('#correctAnswers').textContent = Math.floor(state.score/10);
        $('#totalQuestions').textContent = state.total;
        $('#bestStreak').textContent = '‚Äî';
        setScreen('results'); state.isGameActive = false;
      } else {
        setTimeout(()=> nextQuestion(false), 600);
      }
      updateHud();
    });

    diffButtons.forEach(b=>{
      b.addEventListener('click', ()=>{
        diffButtons.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        state.difficulty = b.dataset.difficulty;
      });
    });

    $('#playAgainBtn').addEventListener('click', ()=>{ setScreen('start'); });

    // Landing
    setScreen('start');
  </script>
</body>
</html>




