<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fungidentification</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5e6d3;
            min-height: 100vh;
            color: #3d2914;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 800'%3E%3Cpath d='M150 100c30-20 60-30 90-20s50 40 40 70c-10 30-40 50-70 40s-60-30-60-60' fill='%23000' opacity='0.03'/%3E%3Cpath d='M900 200c20-15 45-20 65-10s35 35 25 55c-10 20-35 30-55 20s-35-35-35-45' fill='%23000' opacity='0.02'/%3E%3Cpath d='M500 50c0-20 20-40 45-40s45 20 45 40c0 25-20 45-45 45s-45-20-45-45' fill='%23000' opacity='0.02'/%3E%3Cpath d='M100 500c40 0 80 20 80 60s-40 60-80 60s-80-20-80-60 40-60 80-60' fill='%23000' opacity='0.03'/%3E%3Cpath d='M1000 400l20 40-40 20-20-40z' fill='%23000' opacity='0.02'/%3E%3Cpath d='M300 700c15-25 45-35 70-25s35 40 20 65c-15 25-45 35-70 25s-35-40-20-65' fill='%23000' opacity='0.03'/%3E%3C/svg%3E") no-repeat,
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 800'%3E%3Cpath d='M200 300q20-40 60-40t60 40q-20 40-60 40t-60-40' fill='%23000' opacity='0.02'/%3E%3Cpath d='M700 150l30-50 50 30-30 50z' fill='%23000' opacity='0.02'/%3E%3Cpath d='M400 600c0-30 25-55 55-55s55 25 55 55-25 55-55 55-55-25-55-55' fill='%23000' opacity='0.03'/%3E%3C/svg%3E") no-repeat;
            background-position: 0 0, 50% 50%;
            background-size: 100% 100%, 100% 100%;
            pointer-events: none;
            z-index: 1;
        }

        .game-container {
            max-width: 1200px;
            width: 100%;
            background: rgba(255, 248, 240, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(139, 90, 43, 0.15);
            border: 1px solid rgba(139, 90, 43, 0.1);
            position: relative;
            z-index: 2;
        }

        .header { text-align: center; margin-bottom: 30px; }
        h1 { font-size: 2.5em; margin-bottom: 10px; color: #5d4e37; font-weight: 700; letter-spacing: -0.5px; }
        .header p { color: #8b7355; font-size: 1.1em; }

        .game-info { display: flex; justify-content: space-around; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        .info-box { background: rgba(139, 90, 43, 0.08); padding: 15px 25px; border-radius: 10px; text-align: center; min-width: 150px; border: 1px solid rgba(139, 90, 43, 0.15); }
        .info-label { font-size: 0.9em; color: #8b7355; margin-bottom: 5px; }
        .info-value { font-size: 1.8em; font-weight: bold; color: #5d4e37; }

        .start-screen, .loading-screen, .game-screen, .results-screen { display: none; }
        .start-screen.active, .loading-screen.active, .game-screen.active, .results-screen.active { display: block; }

        .start-button, .retry-button, .play-again-button {
            background: linear-gradient(135deg, #8b6f47 0%, #6b5637 100%);
            color: #fff8f0; border: none; padding: 20px 40px; font-size: 1.2em;
            border-radius: 50px; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s;
            margin: 20px auto; display: block; font-weight: 600;
        }
        .start-button:hover, .retry-button:hover, .play-again-button:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(139, 90, 43, 0.3); }
        .modal-content .start-button { margin: 20px auto 0; }

        .image-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr);
            gap: 20px; 
            margin-bottom: 15px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        } 
        .image-container { aspect-ratio: 1; overflow: hidden; border-radius: 15px; position: relative; background: #f0e6d8; box-shadow: 0 5px 15px rgba(139, 90, 43, 0.2); transition: transform 0.3s; border: 2px solid rgba(139, 90, 43, 0.1); }
        .image-container:hover { transform: scale(1.05); box-shadow: 0 8px 25px rgba(139, 90, 43, 0.3); }
        .mushroom-image { width: 100%; height: 100%; object-fit: cover; }

        .game-actions { text-align: center; margin-bottom: 20px; }
        .secondary-action-button {
            background: #d4c8b8; color: #5d4e37; border: 1px solid #bcaea0;
            padding: 10px 20px; font-size: 0.9em; border-radius: 25px; cursor: pointer;
            transition: background-color 0.3s; margin: 0 auto; 
        }
        .secondary-action-button:hover:not(:disabled) { background: #c8bbae; }
        .secondary-action-button:disabled { background: #e0d8ce; color: #a1907f; cursor: not-allowed; }

        .options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 0px; } 
        .option-button {
            background: rgba(255, 248, 240, 0.8); border: 2px solid rgba(139, 90, 43, 0.3);
            color: #5d4e37; padding: 20px; border-radius: 10px; cursor: pointer;
            transition: all 0.3s; font-size: 1.1em; font-weight: 500;
        }
        .option-button:hover:not(:disabled) { background: rgba(139, 90, 43, 0.15); border-color: rgba(139, 90, 43, 0.5); transform: translateY(-2px); }
        .option-button:disabled { cursor: not-allowed; opacity: 0.7; }
        .option-button.correct { background: rgba(76, 175, 80, 0.2); border-color: #4CAF50; color: #2e7d32; }
        .option-button.incorrect { background: rgba(244, 67, 54, 0.2); border-color: #F44336; color: #c62828; }

        .loading-spinner { width: 50px; height: 50px; border: 3px solid rgba(139, 90, 43, 0.2); border-top-color: #8b6f47; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .attribution { font-size: 0.8em; color: #8b7355; text-align: center; margin-top: 10px; grid-column: 1 / -1; } 
        .attribution a { color: #6b5637; text-decoration: none; font-weight: 500; }
        .attribution a:hover { text-decoration: underline; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(61, 41, 20, 0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: #fff8f0; padding: 30px; border-radius: 15px; max-width: 500px; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }
        .error { color: #c9302c; margin: 20px 0; }
        h2, h3 { color: #5d4e37; }

        .game-container::before { content: ''; position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50 10c0 20-10 30-20 40s-20 20-20 30c0-20 10-30 20-40s20-20 20-30z' fill='%238b6f47' opacity='0.05'/%3E%3Cpath d='M70 20c0 15-7 22-15 30s-15 15-15 22c0-15 8-22 15-30s15-15 15-22z' fill='%238b6f47' opacity='0.04'/%3E%3C/svg%3E") no-repeat; transform: rotate(45deg); pointer-events: none; }
        .game-container::after { content: ''; position: absolute; bottom: -30px; left: -30px; width: 120px; height: 120px; background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='20' fill='%238b6f47' opacity='0.03'/%3E%3Ccircle cx='50' cy='50' r='15' fill='%238b6f47' opacity='0.03'/%3E%3Ccircle cx='50' cy='50' r='10' fill='%238b6f47' opacity='0.03'/%3E%3C/svg%3E") no-repeat; transform: rotate(-30deg); pointer-events: none; }

    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>üçÑ Fungidentification</h1>
            <p>Test your mycology knowledge in nature's classroom</p>
        </div>

        <div class="game-info">
            <div class="info-box">
                <div class="info-label">Score</div>
                <div class="info-value" id="score">0</div>
            </div>
            <div class="info-box">
                <div class="info-label">Question</div>
                <div class="info-value" id="questionCounter">0 / 30</div>
            </div>
            <div class="info-box">
                <div class="info-label">Streak</div>
                <div class="info-value" id="streak">0</div>
            </div>
        </div>

        <div class="start-screen active">
            <h2 style="text-align: center; margin-bottom: 20px;">Welcome to the Mushroom ID Challenge!</h2>
            <p style="text-align: center; margin-bottom: 30px;">
                You will be shown 30 mushroom species to identify.<br>
                Each round shows 4 photos of the same species.
            </p>
            <button class="start-button" id="startGameBtn">Start Game</button>
        </div>

        <div class="loading-screen">
            <h2 style="text-align: center; margin-bottom: 20px;">Loading mushroom data...</h2>
            <div class="loading-spinner"></div>
            <p style="text-align: center; margin-top: 20px;">Foraging for fungi on iNaturalist...</p>
        </div>

        <div class="game-screen">
            <div class="image-grid" id="imageGrid"></div>
            <div class="game-actions">
                <button id="newPhotosBtn" class="secondary-action-button" style="display:none;">New Photos (1 use)</button>
            </div>
            <div class="options" id="optionsContainer"></div>
        </div>

        <div class="results-screen">
            <h2 style="text-align: center; margin-bottom: 20px;">Quiz Complete!</h2>
            <div style="text-align: center;">
                <p style="font-size: 1.5em; margin-bottom: 10px;">Final Score: <span id="finalScore">0</span> out of 300</p>
                <p style="margin-bottom: 10px;">Correct Answers: <span id="correctAnswersDisplay">0</span> / <span id="totalQuestionsDisplay">30</span></p>
                <p style="margin-bottom: 10px;">Best Streak: <span id="bestStreak">0</span></p>
                <button class="start-button play-again-button" id="playAgainBtn">Play Again</button>
            </div>
        </div>

        <div class="attribution">
            Images sourced from iNaturalist API under Creative Commons licenses
        </div>
    </div>

    <div class="modal" id="errorModal">
        <div class="modal-content">
            <h3>Oops! Something went wrong</h3>
            <p class="error" id="errorMessage"></p>
            <button class="start-button retry-button" id="errorModalRetryBtn">Try Again</button>
        </div>
    </div>

    <script>
        // DOM Elements
        const scoreDisplay = document.getElementById('score');
        const questionCounterDisplay = document.getElementById('questionCounter');
        const streakDisplay = document.getElementById('streak');
        const imageGrid = document.getElementById('imageGrid');
        const optionsContainer = document.getElementById('optionsContainer');
        const newPhotosBtn = document.getElementById('newPhotosBtn');
        
        const finalScoreDisplay = document.getElementById('finalScore');
        const correctAnswersResultsDisplay = document.getElementById('correctAnswersDisplay');
        const totalQuestionsResultsDisplay = document.getElementById('totalQuestionsDisplay');
        const bestStreakDisplay = document.getElementById('bestStreak');

        const errorModal = document.getElementById('errorModal');
        const errorMessageDisplay = document.getElementById('errorMessage');
        const errorModalRetryBtn = document.getElementById('errorModalRetryBtn');

        const startScreen = document.querySelector('.start-screen');
        const loadingScreen = document.querySelector('.loading-screen');
        const gameScreen = document.querySelector('.game-screen');
        const resultsScreen = document.querySelector('.results-screen');
        
        const startGameBtn = document.getElementById('startGameBtn');
        const playAgainBtn = document.getElementById('playAgainBtn');

        let gameState = {
            score: 0, questionsTarget: 30, questionsAnswered: 0, currentStreak: 0, bestStreak: 0,
            correctAnswersCount: 0, currentQuestion: null, preloadedQuestionData: null,
            activeScreen: 'start', isGameActive: false, seenSpeciesIdsThisGame: new Set(),
            newPhotosUsedThisQuestion: false
        };

        const mushroomSpecies = [
            { id: 48715, name: "Fly Agaric", scientific: "Amanita muscaria", genus: "Amanita" },
            { id: 48350, name: "Oyster Mushroom", scientific: "Pleurotus ostreatus", genus: "Pleurotus" },
            { id: 53715, name: "Lion's Mane", scientific: "Hericium erinaceus", genus: "Hericium" },
            { id: 47392, name: "Turkey Tail", scientific: "Trametes versicolor", genus: "Trametes" }, 
            { id: 55265, name: "Chicken of the Woods", scientific: "Laetiporus sulphureus", genus: "Laetiporus" }, 
            { id: 48431, name: "King Bolete", scientific: "Boletus edulis", genus: "Boletus" },
            { id: 67747, name: "Golden Chanterelle", scientific: "Cantharellus cibarius", genus: "Cantharellus" },
            { id: 54026, name: "Shaggy Mane", scientific: "Coprinus comatus", genus: "Coprinus" },
            { id: 47652, name: "Common Puffball", scientific: "Lycoperdon perlatum", genus: "Lycoperdon" },
            { id: 56021, name: "Velvet Shank", scientific: "Flammulina velutipes", genus: "Flammulina" },
            { id: 117556, name: "Wood Ear", scientific: "Auricularia auricula-judae", genus: "Auricularia" },
            { id: 54844, name: "Honey Mushroom", scientific: "Armillaria mellea", genus: "Armillaria" },
            { id: 125434, name: "Artist's Conk", scientific: "Ganoderma applanatum", genus: "Ganoderma" }, 
            { id: 55646, name: "Field Mushroom", scientific: "Agaricus campestris", genus: "Agaricus" },
            { id: 118394, name: "Yellow Stainer", scientific: "Agaricus xanthodermus", genus: "Agaricus" },
            { id: 70737, name: "Horse Mushroom", scientific: "Agaricus arvensis", genus: "Agaricus" },
            { id: 58691, name: "Pavement Mushroom", scientific: "Agaricus bitorquis", genus: "Agaricus" },
            { id: 60506, name: "Scaly Wood Mushroom", scientific: "Agaricus silvaticus", genus: "Agaricus" }, 
            { id: 55245, name: "Scarlet Waxcap", scientific: "Hygrocybe coccinea", genus: "Hygrocybe" },
            { id: 51869, name: "Crimson Waxcap", scientific: "Hygrocybe punicea", genus: "Hygrocybe" },
            { id: 128868, name: "Blackening Waxcap", scientific: "Hygrocybe conica", genus: "Hygrocybe" }, 
            { id: 63475, name: "Parrot Waxcap", scientific: "Gliophorus psittacinus", genus: "Gliophorus" }, 
            { id: 55240, name: "Meadow Waxcap", scientific: "Cuphophyllus pratensis", genus: "Cuphophyllus" }, 
            { id: 120469, name: "Pale Oyster", scientific: "Pleurotus pulmonarius", genus: "Pleurotus" },
            { id: 334340, name: "Veiled Oyster", scientific: "Pleurotus dryinus", genus: "Pleurotus" },
            { id: 125683, name: "Golden Oyster", scientific: "Pleurotus citrinopileatus", genus: "Pleurotus" },
            { id: 48538, name: "Branched Oyster", scientific: "Pleurotus cornucopiae", genus: "Pleurotus" },
            { id: 53778, name: "Death Cap", scientific: "Amanita phalloides", genus: "Amanita" },
            { id: 67661, name: "The Blusher", scientific: "Amanita rubescens", genus: "Amanita" },
            { id: 49917, name: "Panther Cap", scientific: "Amanita pantherina", genus: "Amanita" },
            { id: 63271, name: "False Death Cap", scientific: "Amanita citrina", genus: "Amanita" },
            { id: 124459, name: "Red-belted Polypore", scientific: "Fomitopsis pinicola", genus: "Fomitopsis" },
            { id: 83490, name: "Birch Polypore", scientific: "Fomitopsis betulina", genus: "Fomitopsis" },
            { id: 58000, name: "Lumpy Bracket", scientific: "Trametes gibbosa", genus: "Trametes" },
            { id: 55244, name: "Reishi Mushroom", scientific: "Ganoderma lucidum", genus: "Ganoderma" }, 
            { id: 120041, name: "Dryad's Saddle", scientific: "Polyporus squamosus", genus: "Polyporus" },
            { id: 57343, name: "Giant Puffball", scientific: "Calvatia gigantea", genus: "Calvatia" },
            { id: 48526, name: "Common Inkcap", scientific: "Coprinopsis atramentaria", genus: "Coprinopsis" },
            { id: 55453, name: "Magpie Inkcap", scientific: "Coprinopsis picacea", genus: "Coprinopsis" },
            { id: 54025, name: "Liberty Cap", scientific: "Psilocybe semilanceata", genus: "Psilocybe" },
            { id: 53903, name: "Bay Bolete", scientific: "Imleria badia", genus: "Imleria" },
            { id: 53478, name: "Slippery Jack", scientific: "Suillus luteus", genus: "Suillus" },
            { id: 63232, name: "Birch Bolete", scientific: "Leccinum scabrum", genus: "Leccinum" },
            { id: 54163, name: "Red Cracking Bolete", scientific: "Xerocomellus chrysenteron", genus: "Xerocomellus" },
            { id: 63211, name: "Bitter Beech Bolete", scientific: "Caloboletus calopus", genus: "Caloboletus" },
            { id: 63460, name: "Bleeding Bonnet", scientific: "Mycena haematopus", genus: "Mycena" },
            { id: 63446, name: "Common Bonnet", scientific: "Mycena galericulata", genus: "Mycena" },
            { id: 63471, name: "Clustered Bonnet", scientific: "Mycena inclinata", genus: "Mycena" },
            { id: 63478, name: "Lilac Bonnet", scientific: "Mycena pura", genus: "Mycena" },
            { id: 130195, name: "Saffrondrop Bonnet", scientific: "Mycena crocata", genus: "Mycena" }
        ];


        const observationCache = new Map();
        const LOCAL_STORAGE_KEY = 'observationCache';

        function saveCacheToLocalStorage() {
            try {
                const obj = {};
                for (const [key, value] of observationCache.entries()) {
                    obj[key] = value;
                }
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(obj));
            } catch (e) {
                console.warn('Failed to save cache to localStorage', e);
            }
        }

        function loadCacheFromLocalStorage() {
            try {
                const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (!stored) return;
                const parsed = JSON.parse(stored);
                const now = Date.now();
                for (const key in parsed) {
                    const entry = parsed[key];
                    if (entry.timestamp && entry.timestamp > now - 86400000 && entry.data) {
                        observationCache.set(key, entry);
                    }
                }
            } catch (e) {
                console.warn('Failed to load cache from localStorage', e);
            }
        }

        let currentErrorRetryCallback = null;

        function switchScreen(screenName) {
            startScreen.classList.remove('active'); loadingScreen.classList.remove('active');
            gameScreen.classList.remove('active'); resultsScreen.classList.remove('active');
            if (screenName === 'start') startScreen.classList.add('active');
            else if (screenName === 'loading') loadingScreen.classList.add('active');
            else if (screenName === 'game') gameScreen.classList.add('active');
            else if (screenName === 'results') resultsScreen.classList.add('active');
            gameState.activeScreen = screenName;
        }
        
        async function fetchMushroomObservations(taxonId, excludeObservationId = null) {
            const requestedSpeciesInfo = mushroomSpecies.find(s => s.id === taxonId);
            let apiUrl = `https://api.inaturalist.org/v1/observations?taxon_id=${taxonId}&iconic_taxa=Fungi&quality_grade=research&photos=true&photo_license=cc-by,cc-by-nc,cc-by-sa,cc-by-nc-sa,cc0&per_page=50&order_by=votes&locale=en`;
            if (excludeObservationId) {
                apiUrl += `&not_id=${excludeObservationId}`;
            }

            const cacheKey = taxonId + (excludeObservationId || '');
            if (observationCache.has(cacheKey)) {
                const cached = observationCache.get(cacheKey);
                if (cached.timestamp > Date.now() - 3600000 * 24) { 
                    return {...cached.data}; 
                }
            }
            
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`API ${response.status} for taxon ${taxonId}`);
                
                let data = await response.json();
                // Filter for observations with at least 1 photo
                let observationsWithPhotos = data.results.filter(obs => obs.photos && obs.photos.length >= 1 && obs.taxon);
                
                if (observationsWithPhotos.length === 0) {
                    console.warn(`No observations with photos found for taxon ${taxonId} (intended: ${requestedSpeciesInfo?.name})${excludeObservationId ? ` (excluding obs ID ${excludeObservationId})` : ''}.`);
                    return { photos: [], attribution: "Not enough quality photos found.", observationUrl: null, error: true, speciesId: taxonId, observationId: null };
                }
                
                observationsWithPhotos.sort(() => 0.5 - Math.random()); 

                let suitableObservation = null;
                for (const obs of observationsWithPhotos) {
                    const obsTaxon = obs.taxon; 
                    if (obsTaxon.id === taxonId || (obsTaxon.ancestor_ids && obsTaxon.ancestor_ids.includes(taxonId))) {
                        suitableObservation = obs;
                        break; 
                    } else {
                         console.warn(`[STRICT CHECK FAILED OBS DURING ITERATION] Req: ${taxonId} (${requestedSpeciesInfo?.name}). ObsID ${obs.id} is Taxon: ${obsTaxon.id} (${obsTaxon.name}). Skipping.`);
                    }
                }

                if (!suitableObservation) { 
                     console.error(`[NO STRICT MATCH] No observation for taxon ${taxonId} (${requestedSpeciesInfo?.name}) passed strict ID check from ${observationsWithPhotos.length} candidates.`);
                    return { photos: [], attribution: "Could not find accurately matched photos.", error: true, speciesId: taxonId, observationId: null };
                }
                
                const selectedObservation = suitableObservation; 
                const finalObsTaxon = selectedObservation.taxon; 

                // Get first 3 photos, or duplicate the first if needed to make 4
                const availablePhotos = selectedObservation.photos.slice(0, 3);
                let gamePhotos = availablePhotos.map((photo, index) => ({
                    url: photo.url.replace('square', 'medium'),
                    attribution: photo.attribution || "iNaturalist contributor"
                }));
                
                // If we have fewer than 4 photos, duplicate the first photo to fill the 4th slot
                while (gamePhotos.length < 4) {
                    if (gamePhotos.length > 0) {
                        gamePhotos.push({
                            url: gamePhotos[0].url,
                            attribution: gamePhotos[0].attribution
                        });
                    } else {
                        break; // Shouldn't happen, but safety check
                    }
                }
                
                const result = {
                    photos: gamePhotos,
                    attribution: `Photos by ${selectedObservation.user?.login || 'Unknown User'} via iNaturalist (${availablePhotos[0]?.license_code || 'License N/A'})`,
                    observationUrl: selectedObservation.uri,
                    observationId: selectedObservation.id,
                    error: false, speciesId: taxonId 
                };
                
                observationCache.set(cacheKey, { data: {...result}, timestamp: Date.now() });
                saveCacheToLocalStorage();
                return result;
                
            } catch (error) {
                console.error(`API Error in fetchMushroomObservations for taxon ${taxonId} (intended: ${requestedSpeciesInfo?.name}):`, error);
                return { photos: [], attribution: "Error fetching species data.", error: true, speciesId: taxonId, observationId: null };
            }
        }

        async function startGame() {
            gameState.score = 0; gameState.questionsAnswered = 0; gameState.currentStreak = 0;
            gameState.bestStreak = 0; gameState.correctAnswersCount = 0; gameState.isGameActive = true;
            gameState.preloadedQuestionData = null; gameState.seenSpeciesIdsThisGame.clear();
            updateDisplay(); questionCounterDisplay.textContent = `0 / ${gameState.questionsTarget}`; 
            switchScreen('loading');
            try {
                await loadNewQuestion(true); 
                if (!gameState.isGameActive) return; 
                switchScreen('game');
                preloadNextQuestion(); 
            } catch (error) { 
                console.error("Failed to start game (error from initial loadNewQuestion):", error.message);
                showError(
                    error.message.includes("Failed to load initial question")
                        ? "Could not load the first mushroom question. Please try again." 
                        : "An error occurred while starting the game. Please try again.",
                    resetGame, "Restart Game"
                );
                gameState.isGameActive = false;
            }
        }

        function updateQuestionCounter() {
            questionCounterDisplay.textContent = `${gameState.questionsAnswered + 1} / ${gameState.questionsTarget}`;
        }
        function updateDisplay() {
            scoreDisplay.textContent = gameState.score; streakDisplay.textContent = gameState.currentStreak;
        }

        async function loadNewQuestion(isInitialLoad = false) {
            if (!gameState.isGameActive || gameState.questionsAnswered >= gameState.questionsTarget) {
                if (gameState.questionsAnswered >= gameState.questionsTarget && gameState.isGameActive) endGame();
                return;
            }
            newPhotosBtn.style.display = 'none'; 
            imageGrid.innerHTML = '<div class="loading-spinner" style="grid-column: 1/-1;"></div>';
            optionsContainer.innerHTML = '';
            if(gameState.questionsAnswered < gameState.questionsTarget) updateQuestionCounter();

            let validQuestionLoaded = false; let attempts = 0; const maxLoadAttempts = 7; 
            let currentSelectedCorrectSpecies = null; let currentObservationData = null;
            let speciesTriedThisSlot = new Set(); 

            while (!validQuestionLoaded && attempts < maxLoadAttempts) {
                attempts++;
                let potentialSpecies;
                let availableForSelection = mushroomSpecies.filter(s => !gameState.seenSpeciesIdsThisGame.has(s.id) && !speciesTriedThisSlot.has(s.id) );
                if (availableForSelection.length === 0) { 
                    availableForSelection = mushroomSpecies.filter(s => !speciesTriedThisSlot.has(s.id));
                    if (availableForSelection.length === 0) { console.error("CRITICAL: All species tried for this slot."); break; }
                }
                potentialSpecies = availableForSelection[Math.floor(Math.random() * availableForSelection.length)];
                if (!potentialSpecies) { console.error("Error: Could not select potential species."); break; }
                currentSelectedCorrectSpecies = potentialSpecies;
                speciesTriedThisSlot.add(currentSelectedCorrectSpecies.id);
                
                try {
                    if (gameState.preloadedQuestionData?.speciesId === currentSelectedCorrectSpecies.id && !gameState.preloadedQuestionData.data.error) {
                        currentObservationData = gameState.preloadedQuestionData.data; 
                        gameState.preloadedQuestionData = null; 
                    } else {
                        currentObservationData = await fetchMushroomObservations(currentSelectedCorrectSpecies.id);
                    }
                    // Check for at least 1 photo (we'll create 4 total)
                    if (currentObservationData && !currentObservationData.error && currentObservationData.photos?.length >= 1) {
                        validQuestionLoaded = true;
                    } else {
                         if (gameState.preloadedQuestionData?.speciesId === currentSelectedCorrectSpecies.id) gameState.preloadedQuestionData = null; 
                    }
                } catch (fetchError) {
                     console.error(`Error during fetch for ${currentSelectedCorrectSpecies.name}:`, fetchError);
                    currentObservationData = null; 
                }
            } 

            if (!validQuestionLoaded) {
                if (isInitialLoad) throw new Error("Failed to load initial question after multiple attempts.");
                else {
                    showError("Could not find a suitable mushroom for the next question.", () => { if (gameState.isGameActive) loadNewQuestion(false); }, "Try Next");
                    imageGrid.innerHTML = '<p style="text-align:center; grid-column: 1/-1;">Could not load question.</p>'; 
                    return; 
                }
            }
            
            gameState.seenSpeciesIdsThisGame.add(currentSelectedCorrectSpecies.id); 
            gameState.newPhotosUsedThisQuestion = false; 
            newPhotosBtn.style.display = 'block'; newPhotosBtn.disabled = false; newPhotosBtn.textContent = "New Photos (1 use)";

            const correctSpeciesForOptions = currentSelectedCorrectSpecies;
            const options = [correctSpeciesForOptions]; const correctGenus = correctSpeciesForOptions.genus;
            let sameGenusOptions = mushroomSpecies.filter(s => s.genus === correctGenus && s.id !== correctSpeciesForOptions.id).sort(() => 0.5 - Math.random());
            for (let i = 0; i < 2 && sameGenusOptions.length > 0; i++) {
                if (options.length < 4) {
                    const speciesToAdd = sameGenusOptions.shift();
                    if (!options.some(opt => opt.id === speciesToAdd.id)) options.push(speciesToAdd); else i--;
                }
            }
            let differentGenusOptions = mushroomSpecies.filter(s => s.genus !== correctGenus && !options.some(opt => opt.id === s.id)).sort(() => 0.5 - Math.random());
            while (options.length < 4 && differentGenusOptions.length > 0) {
                const speciesToAdd = differentGenusOptions.shift();
                 if (!options.some(opt => opt.id === speciesToAdd.id)) options.push(speciesToAdd);
            }
            let allOtherSpecies = mushroomSpecies.filter(s => !options.some(opt => opt.id === s.id)).sort(() => 0.5 - Math.random());
            while (options.length < 4 && allOtherSpecies.length > 0) options.push(allOtherSpecies.shift());
            while (options.length > 4) options.pop();
            while (options.length < 4 && mushroomSpecies.length >= 4) { 
                 let fillOptions = mushroomSpecies.filter(s => !options.some(opt => opt.id === s.id));
                 if (fillOptions.length > 0) options.push(fillOptions[Math.floor(Math.random()*fillOptions.length)]); else break; 
            }
            options.sort(() => 0.5 - Math.random());
            
            gameState.currentQuestion = {
                correct: correctSpeciesForOptions, options: options,
                observationUrl_DEBUG: currentObservationData.observationUrl,
                currentObservationId: currentObservationData.observationId
            };
            
            // Display 4 images in 2x2 grid
            imageGrid.innerHTML = currentObservationData.photos.map(photo => `
                <div class="image-container">
                    <img src="${photo.url}" alt="Mushroom photo" class="mushroom-image" onerror="handleImageError(this)">
                </div>`).join('');
            const attributionDivOld = imageGrid.querySelector('.attribution'); if(attributionDivOld) attributionDivOld.remove(); 
            const attributionDiv = document.createElement('div');
            attributionDiv.className = 'attribution';
            let attributionText = currentObservationData.attribution;
            if (currentObservationData.observationUrl) attributionText += ` <a href="${currentObservationData.observationUrl}" target="_blank" rel="noopener noreferrer" style="color: #667eea;">View on iNaturalist</a>`;
            attributionDiv.innerHTML = attributionText;
            if (!imageGrid.contains(attributionDiv)) imageGrid.appendChild(attributionDiv);
            
            optionsContainer.innerHTML = gameState.currentQuestion.options.map((species, index) => `
                <button class="option-button" data-species-index="${index}">${species.name}<br><small style="opacity: 0.7;"><em>${species.scientific}</em></small></button>`).join('');

            if (gameState.isGameActive) preloadNextQuestion(currentSelectedCorrectSpecies.id);
        }
        
        async function handleNewPhotosRequest() {
            if (!gameState.isGameActive || !gameState.currentQuestion || gameState.newPhotosUsedThisQuestion) return;
            gameState.newPhotosUsedThisQuestion = true; newPhotosBtn.disabled = true; newPhotosBtn.textContent = "Loading...";
            const taxonId = gameState.currentQuestion.correct.id;
            const excludeId = gameState.currentQuestion.currentObservationId;
            const newObservationData = await fetchMushroomObservations(taxonId, excludeId);

            // Check for at least 1 photo (we'll create 4 total)
            if (newObservationData && !newObservationData.error && newObservationData.photos?.length >= 1) {
                // Display 4 images in 2x2 grid
                imageGrid.innerHTML = newObservationData.photos.map(photo => `
                    <div class="image-container">
                        <img src="${photo.url}" alt="Mushroom photo" class="mushroom-image" onerror="handleImageError(this)">
                    </div>`).join('');
                const oldAttribution = imageGrid.querySelector('.attribution'); if(oldAttribution) oldAttribution.remove();
                const attributionDiv = document.createElement('div'); attributionDiv.className = 'attribution';
                let attributionText = newObservationData.attribution;
                if (newObservationData.observationUrl) attributionText += ` <a href="${newObservationData.observationUrl}" target="_blank" rel="noopener noreferrer" style="color: #667eea;">View on iNaturalist</a>`;
                attributionDiv.innerHTML = attributionText; imageGrid.appendChild(attributionDiv);
                gameState.currentQuestion.currentObservationId = newObservationData.observationId;
                gameState.currentQuestion.observationUrl_DEBUG = newObservationData.observationUrl;
                newPhotosBtn.textContent = "New Photos Used";
            } else {
                showError("Could not find alternative photos for this mushroom.", null, "OK");
                newPhotosBtn.textContent = "No Alternatives Found"; 
            }
        }

        function selectAnswer(selectedIndex) {
            if (!gameState.currentQuestion || !gameState.isGameActive) return;
            const selected = gameState.currentQuestion.options[selectedIndex];
            const correct = gameState.currentQuestion.correct; 
            const buttons = optionsContainer.querySelectorAll('.option-button');
            buttons.forEach(button => button.disabled = true); newPhotosBtn.disabled = true; 
            if (selected.id === correct.id) {
                gameState.score += 10; gameState.currentStreak++; gameState.correctAnswersCount++;
                if (gameState.currentStreak > gameState.bestStreak) gameState.bestStreak = gameState.currentStreak;
                buttons[selectedIndex].classList.add('correct');
            } else {
                gameState.currentStreak = 0; buttons[selectedIndex].classList.add('incorrect');
                const correctButtonIndex = gameState.currentQuestion.options.findIndex(opt => opt.id === correct.id);
                if (correctButtonIndex !== -1) buttons[correctButtonIndex].classList.add('correct');
                console.warn(`Incorrect Answer. User selected: ${selected.name} (ID: ${selected.id}). Correct was: ${correct.name} (ID: ${correct.id}).`);
                if (gameState.currentQuestion?.observationUrl_DEBUG) console.warn(`Photos were for observation: ${gameState.currentQuestion.observationUrl_DEBUG}`);
            }
            gameState.questionsAnswered++; updateDisplay(); 
            setTimeout(() => {
                if (gameState.isGameActive) { 
                    if (gameState.questionsAnswered >= gameState.questionsTarget) endGame();
                    else loadNewQuestion(false); 
                }
            }, 2000); 
        }

        function endGame() {
            if (!gameState.isGameActive && gameState.activeScreen === 'results') return; 
            gameState.isGameActive = false;
            finalScoreDisplay.textContent = gameState.score;
            correctAnswersResultsDisplay.textContent = gameState.correctAnswersCount;
            totalQuestionsResultsDisplay.textContent = gameState.questionsTarget; 
            bestStreakDisplay.textContent = gameState.bestStreak;
            switchScreen('results');
        }

        function resetGame() {
            gameState.isGameActive = false; gameState.score = 0; gameState.questionsAnswered = 0;
            gameState.currentStreak = 0; gameState.bestStreak = 0; gameState.correctAnswersCount = 0;
            gameState.seenSpeciesIdsThisGame.clear(); newPhotosBtn.style.display = 'none';
            updateDisplay(); questionCounterDisplay.textContent = `0 / ${gameState.questionsTarget}`;
            switchScreen('start');
        }
        
        function closeModal() {
            errorModal.classList.remove('active');
            if (currentErrorRetryCallback) {
                errorModalRetryBtn.removeEventListener('click', currentErrorRetryCallback);
                currentErrorRetryCallback = null;
            }
        }
        function showError(message, retryCallback = null, retryButtonText = "Try Again") {
            errorMessageDisplay.textContent = message;
            if (currentErrorRetryCallback) errorModalRetryBtn.removeEventListener('click', currentErrorRetryCallback);
            currentErrorRetryCallback = () => { closeModal(); if (retryCallback) retryCallback(); };
            errorModalRetryBtn.textContent = retryButtonText;
            errorModalRetryBtn.addEventListener('click', currentErrorRetryCallback);
            errorModal.classList.add('active');
        }
        function handleImageError(img) {
            img.src = 'https://via.placeholder.com/400x400/cccccc/777777?text=Image+Load+Error';
            img.alt = 'Image failed to load';
        }
        async function preloadNextQuestion(currentCorrectSpeciesId = null) {
            if (gameState.preloadedQuestionData || !gameState.isGameActive || gameState.questionsAnswered >= gameState.questionsTarget) return; 
            let potentialSpeciesToPreload;
            let availableForPreload = mushroomSpecies.filter(s => s.id !== currentCorrectSpeciesId && !gameState.seenSpeciesIdsThisGame.has(s.id));
            if(availableForPreload.length === 0) { 
                availableForPreload = mushroomSpecies.filter(s => s.id !== currentCorrectSpeciesId); 
                 if(availableForPreload.length === 0 && mushroomSpecies.length > 0) potentialSpeciesToPreload = mushroomSpecies[0]; 
                 else if (availableForPreload.length > 0) potentialSpeciesToPreload = availableForPreload[Math.floor(Math.random() * availableForPreload.length)];
                 else return; 
            } else potentialSpeciesToPreload = availableForPreload[Math.floor(Math.random() * availableForPreload.length)];
            if (!potentialSpeciesToPreload) return;
            try {
                const data = await fetchMushroomObservations(potentialSpeciesToPreload.id);
                // Check for at least 1 photo (we'll create 4 total)
                if (data && !data.error && data.photos?.length >= 1) gameState.preloadedQuestionData = { speciesId: potentialSpeciesToPreload.id, data: data }; 
                else gameState.preloadedQuestionData = null;
            } catch (error) { console.error('Preload fetch failed:', error); gameState.preloadedQuestionData = null; }
        }
        async function checkAPIStatus() {
            try {
                const response = await fetch('https://api.inaturalist.org/v1/observations?per_page=1');
                if (!response.ok) showError('iNaturalist API may be having issues. Please try again later.', checkAPIStatus, "Retry API Check");
            } catch (error) { showError('Cannot connect to iNaturalist API. Please check your internet and try again.', checkAPIStatus, "Retry Connection"); }
        }
        startGameBtn.addEventListener('click', startGame);
        playAgainBtn.addEventListener('click', resetGame);
        newPhotosBtn.addEventListener('click', handleNewPhotosRequest);
        optionsContainer.addEventListener('click', function(event) {
            const button = event.target.closest('.option-button');
            if (button && !button.disabled) { 
                const speciesIndex = parseInt(button.dataset.speciesIndex);
                if (!isNaN(speciesIndex)) selectAnswer(speciesIndex);
            }
        });
        window.addEventListener('load', () => {
            loadCacheFromLocalStorage();
            checkAPIStatus();
            questionCounterDisplay.textContent = `0 / ${gameState.questionsTarget}`;
            switchScreen('start');
        });
    </script>
</body>
</html>